<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F5F5F7">
    <title>Gesture Game 2025</title>
    <style>
        /* --- 2025 Modern Light Theme --- */
        :root {
            --bg-app: #F5F5F7;
            --surface: #FFFFFF;
            --surface-secondary: #EBEBF0;
            --text-main: #1D1D1F;
            --text-sub: #86868B;
            --accent: #007AFF;
            --accent-gradient: linear-gradient(135deg, #007AFF, #00C7BE);
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --radius-lg: 24px;
            --radius-md: 16px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            width: 100vw;
            height: 100dvh;
            position: fixed;
            inset: 0;
            overflow: hidden; /* bodyè‡ªä½“ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
        }

        /* --- Screen Layout --- */
        .screen {
            position: absolute;
            inset: 0;
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
            flex-direction: column;
            background: var(--bg-app);
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
            
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®šã®è‚ */
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            
            /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œï¼‰ */
            padding: calc(var(--safe-top) + 20px) 24px calc(var(--safe-bottom) + 20px);
        }

        .screen.active {
            display: flex; /* Flexboxã¨ã—ã¦è¡¨ç¤º */
            opacity: 1;
            z-index: 20;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå°‘ãªã„æ™‚ã‚‚ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å´©ã•ãªã„ */
        .screen-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç”»é¢ã‚ˆã‚Šå°ã•ãã¦ã‚‚é«˜ã•ã‚’ç¢ºä¿ */
            min-height: min-content; 
        }

        /* --- Typography & Components --- */
        h1 {
            font-size: 34px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #1D1D1F 0%, #434344 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 15px;
            color: var(--text-sub);
            margin-bottom: 32px;
            font-weight: 500;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 16px;
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0;
            border-bottom: 1px solid var(--surface-secondary);
            cursor: pointer;
        }
        .card-row:last-child { border-bottom: none; }
        .card-row:active { opacity: 0.6; }

        .label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 17px;
            font-weight: 600;
        }
        .icon-box {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--surface-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .value {
            color: var(--accent);
            font-weight: 600;
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-container {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .toggle-switch {
            width: 51px;
            height: 31px;
            background: var(--surface-secondary);
            border-radius: 16px;
            position: relative;
            transition: 0.3s;
            cursor: pointer;
        }
        .toggle-knob {
            width: 27px;
            height: 27px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: 0.3s cubic-bezier(0.3, 1.5, 0.7, 1);
        }
        .toggle-container.active .toggle-switch { background: var(--success); }
        .toggle-container.active .toggle-knob { transform: translateX(20px); }

        .btn-primary {
            width: 100%;
            padding: 18px;
            background: var(--accent-gradient);
            color: white;
            font-size: 18px;
            font-weight: 700;
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.2);
            cursor: pointer;
            margin-top: auto; /* ç”»é¢ä¸‹éƒ¨ã«æŠ¼ã—å‡ºã— */
            margin-bottom: 20px;
        }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary:disabled { background: var(--surface-secondary); color: var(--text-sub); box-shadow: none; cursor: not-allowed; }

        .list-item {
            background: var(--surface);
            padding: 18px 24px;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 17px;
            font-weight: 500;
        }
        .list-item.selected { color: var(--accent); font-weight: 700; }

        /* --- Game Screen Specifics --- */
        #game-screen {
            background: #000000;
            padding: 0;
            overflow: hidden; /* ã‚²ãƒ¼ãƒ ç”»é¢ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
            touch-action: none;
        }

        .camera-layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.4;
            transform: scaleX(-1);
            z-index: 1;
        }

        .game-ui-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: 20px 40px; /* æ¨ªæŒã¡æƒ³å®šã®ä½™ç™½ */
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
        }
        .timer { font-size: 32px; font-weight: 800; color: white; font-variant-numeric: tabular-nums; }
        .timer.warning { color: var(--danger); animation: pulse 0.8s infinite; }
        .score { font-size: 24px; font-weight: 700; color: white; }

        .question-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .question-text {
            color: white;
            font-size: clamp(40px, 12vw, 100px);
            font-weight: 900;
            text-align: center;
            line-height: 1.1;
            text-shadow: 0 4px 12px rgba(0,0,0,0.5);
            word-break: keep-all;
        }

        .guide-text {
            position: absolute;
            bottom: 20px;
            right: 40px;
            text-align: right;
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            line-height: 1.5;
            pointer-events: none;
        }

        .feedback-overlay {
            position: absolute;
            inset: 0;
            z-index: 50;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
        }
        .feedback-overlay.show { opacity: 1; }
        .feedback-overlay.correct { background: rgba(52, 199, 89, 0.9); }
        .feedback-overlay.pass { background: rgba(255, 149, 0, 0.9); }
        .fb-icon { font-size: 100px; margin-bottom: 10px; }
        .fb-text { font-size: 48px; font-weight: 900; color: white; }

        /* --- Result Screen --- */
        .result-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .result-score { font-size: 80px; font-weight: 800; color: var(--accent); margin: 10px 0; }
        .result-list-container {
            width: 100%;
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .result-row {
            padding: 12px 16px;
            border-bottom: 1px solid var(--surface-secondary);
            display: flex;
            justify-content: space-between;
            font-size: 15px;
        }

        @keyframes pulse { 50% { opacity: 0.5; } }

        /* --- Utility --- */
        #rotate-warning {
            position: fixed;
            inset: 0;
            background: var(--bg-app);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        @media (orientation: portrait) { #rotate-warning { display: flex; } }
        
        #error-msg {
            color: var(--danger);
            font-size: 12px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <!-- 1. ç¸¦æŒã¡è­¦å‘Š -->
    <div id="rotate-warning">
        <div style="font-size:60px; margin-bottom:20px;">ğŸ”„</div>
        <h2>ã‚¹ãƒãƒ›ã‚’æ¨ªå‘ãã«ã—ã¦ã­</h2>
    </div>

    <!-- 2. ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆè¨±å¯ç”»é¢ï¼‰ -->
    <div id="screen-splash" class="screen active">
        <div class="screen-content-wrapper" style="justify-content: center; align-items: center; text-align: center;">
            <div style="font-size:80px; margin-bottom:20px;">ğŸ­</div>
            <h1>Gesture Game</h1>
            <p class="subtitle">2025 Edition</p>
            <p style="margin-bottom:30px; color:var(--text-sub); font-size:14px; line-height:1.6;">
                ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹ã«ã¯ã€<br>ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚
            </p>
            <button class="btn-primary" onclick="requestInitialPermission()" style="margin-bottom:0;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
    </div>

    <!-- 3. ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="screen-home" class="screen">
        <div class="screen-content-wrapper">
            <div>
                <h1>è¨­å®š</h1>
                <p class="subtitle">ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã‚ˆã†</p>
            </div>

            <div class="card">
                <div class="card-row" onclick="openGenreList()">
                    <div class="label"><div class="icon-box">ğŸ“</div><span>ã‚¸ãƒ£ãƒ³ãƒ«</span></div>
                    <div class="value"><span id="display-genre">æœªé¸æŠ</span><span>â€º</span></div>
                </div>
                <div class="card-row" onclick="openTimeList()">
                    <div class="label"><div class="icon-box">â±ï¸</div><span>åˆ¶é™æ™‚é–“</span></div>
                    <div class="value"><span id="display-time">60ç§’</span><span>â€º</span></div>
                </div>
            </div>

            <div class="toggle-container" id="camera-toggle-btn" onclick="toggleCamera()">
                <div class="label">
                    <div class="icon-box" style="background:#FFEBEB; color:#FF3B30;">ğŸ“¹</div>
                    <span>ãƒ—ãƒ¬ã‚¤ã‚’éŒ²ç”»</span>
                </div>
                <div class="toggle-switch"><div class="toggle-knob"></div></div>
            </div>

            <div id="error-msg">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„</div>

            <button id="btn-start" class="btn-primary" disabled onclick="startGameFlow()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
    </div>

    <!-- 4. ãƒªã‚¹ãƒˆé¸æŠç”»é¢ -->
    <div id="screen-list" class="screen" style="background:var(--surface-secondary); padding:0;">
        <div style="background:var(--bg-app); padding:16px 20px; display:flex; justify-content:space-between; align-items:center;">
            <button onclick="goHome()" style="border:none; background:none; color:var(--accent); font-size:17px; font-weight:500;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <span style="font-weight:700;">é¸æŠ</span>
            <div style="width:50px;"></div>
        </div>
        <div id="list-content" style="flex:1; overflow-y:auto; padding-bottom:40px;"></div>
    </div>

    <!-- 5. ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
    <div id="screen-countdown" class="screen" style="justify-content:center; align-items:center;">
        <div style="font-size:120px; font-weight:900; color:var(--accent);" id="count-number">3</div>
        <p style="margin-top:20px; font-weight:600; font-size:20px;">å‚ç›´ã«æ§‹ãˆã¦ï¼</p>
    </div>

    <!-- 6. ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="game-screen" class="screen">
        <!-- ã‚«ãƒ¡ãƒ©æ˜ åƒãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
        <video id="camera-feed" class="camera-layer" autoplay playsinline muted></video>
        
        <!-- UIãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
        <div class="game-ui-layer">
            <div class="game-header">
                <div class="timer" id="game-timer">60</div>
                <div class="score"><span id="game-score">0</span>å•</div>
            </div>
            
            <div class="question-area">
                <div class="question-text" id="question-display">Ready?</div>
            </div>

            <div class="guide-text">
                ç”»é¢ã‚’åœ°é¢ã¸ â¤µ æ­£è§£<br>
                ç”»é¢ã‚’ç©ºã¸ â¤´ ãƒ‘ã‚¹
            </div>
        </div>

        <!-- åˆ¤å®šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
        <div id="feedback-overlay" class="feedback-overlay">
            <div class="fb-icon" id="fb-icon">â­•</div>
            <div class="fb-text" id="fb-text">æ­£è§£ï¼</div>
        </div>
    </div>

    <!-- 7. çµæœç”»é¢ -->
    <div id="screen-result" class="screen">
        <div class="screen-content-wrapper">
            <h2 style="text-align:center; margin-top:20px;">çµæœç™ºè¡¨</h2>
            <div class="result-content">
                <div class="result-score"><span id="result-number">0</span><span style="font-size:30px; color:var(--text-main);">å•</span></div>
                
                <div class="result-list-container">
                    <div style="padding:10px 16px; background:#fafafa; font-size:12px; font-weight:700; color:#888;">æ­£è§£ã—ãŸãŠé¡Œ</div>
                    <div id="result-list-correct"></div>
                </div>
                
                <div class="result-list-container">
                    <div style="padding:10px 16px; background:#fafafa; font-size:12px; font-weight:700; color:#888;">ãƒ‘ã‚¹ã—ãŸãŠé¡Œ</div>
                    <div id="result-list-pass"></div>
                </div>
            </div>
            <button class="btn-primary" onclick="goHome()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // è¨­å®š: JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        const GENRES_FILE = 'data/genres.json';
        
        // çŠ¶æ…‹ç®¡ç†
        const state = {
            genres: [],
            selectedGenre: null,
            time: 60,
            useCamera: false,
            // ã‚²ãƒ¼ãƒ ä¸­
            questions: [],
            qIndex: 0,
            correct: [],
            pass: [],
            timeLeft: 0,
            isPlaying: false,
            // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯: 'neutral'(å‚ç›´å¾…ã¡) or 'triggered'(æˆ»ã‚Šå¾…ã¡)
            motionState: 'neutral'
        };

        const $ = id => document.getElementById(id);

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆç®¡ç†
        function switchScreen(screenId) {
            // ã™ã¹ã¦ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’éè¡¨ç¤º
            document.querySelectorAll('.screen').forEach(el => {
                el.classList.remove('active');
            });
            
            // æŒ‡å®šã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’è¡¨ç¤º
            const target = $(`screen-${screenId}`);
            if(target) target.classList.add('active');
            
            // ã‚²ãƒ¼ãƒ ç”»é¢ã®å ´åˆã®ã¿IDãŒé•ã†ãŸã‚ç‰¹ä¾‹å‡¦ç†
            if (screenId === 'game') {
                $('game-screen').classList.add('active');
            } else {
                $('game-screen').classList.remove('active');
            }
        }

        // --- åˆæœŸåŒ– & æ¨©é™ ---
        async function requestInitialPermission() {
            // iOS 13+ åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼è¨±å¯
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const res = await DeviceMotionEvent.requestPermission();
                    if (res === 'granted') {
                        initData();
                    } else {
                        alert('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã§ã™');
                    }
                } catch (e) {
                    initData(); // Androidç­‰ã¯ã“ã“ã§ç¶šè¡Œ
                }
            } else {
                initData();
            }
        }

        async function initData() {
            try {
                // Fetch Genres
                const res = await fetch(GENRES_FILE);
                if (!res.ok) throw new Error('Network error');
                const files = await res.json();
                
                state.genres = await Promise.all(files.map(async f => {
                    const r = await fetch(`data/${f}`);
                    return r.json();
                }));
                
                switchScreen('home');
            } catch (e) {
                console.error(e);
                switchScreen('home');
                $('error-msg').style.display = 'block';
                $('error-msg').innerText += ` (${e.message})`;
            }
        }

        // --- ãƒ›ãƒ¼ãƒ ç”»é¢æ“ä½œ ---
        function openGenreList() {
            const html = state.genres.map(g => `
                <div class="list-item ${state.selectedGenre?.id === g.id ? 'selected' : ''}" 
                     onclick="selectGenre('${g.id}')">
                    <span>${g.icon} ${g.name}</span>
                    ${state.selectedGenre?.id === g.id ? '<span>âœ”</span>' : ''}
                </div>
            `).join('');
            $('list-content').innerHTML = html;
            switchScreen('list');
        }

        function selectGenre(id) {
            state.selectedGenre = state.genres.find(g => g.id === id);
            $('display-genre').innerText = state.selectedGenre.name;
            $('btn-start').disabled = false;
            goHome();
        }

        function openTimeList() {
            const times = [30, 60, 90, 120, 180];
            const html = times.map(t => `
                <div class="list-item ${state.time === t ? 'selected' : ''}" 
                     onclick="selectTime(${t})">
                    <span>${t}ç§’</span>
                    ${state.time === t ? '<span>âœ”</span>' : ''}
                </div>
            `).join('');
            $('list-content').innerHTML = html;
            switchScreen('list');
        }

        function selectTime(t) {
            state.time = t;
            $('display-time').innerText = t + 'ç§’';
            goHome();
        }

        function goHome() { switchScreen('home'); }

        // --- ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ ---
        async function toggleCamera() {
            const btn = $('camera-toggle-btn');
            if (!state.useCamera) {
                // ONã«ã™ã‚‹å‰ã«è¨±å¯ç¢ºèª
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(t => t.stop()); // ä¸€æ—¦æ­¢ã‚ã‚‹
                    state.useCamera = true;
                    btn.classList.add('active');
                } catch (e) {
                    alert('ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒã‚ã‚Šã¾ã›ã‚“');
                    state.useCamera = false;
                    btn.classList.remove('active');
                }
            } else {
                state.useCamera = false;
                btn.classList.remove('active');
            }
        }

        // --- ã‚²ãƒ¼ãƒ é–‹å§‹ ---
        function startGameFlow() {
            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è©¦è¡Œ
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(()=>{});
            }

            // ã‚«ãƒ¡ãƒ©æº–å‚™
            if (state.useCamera) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false })
                    .then(stream => $('camera-feed').srcObject = stream)
                    .catch(e => console.error(e));
            } else {
                $('camera-feed').srcObject = null;
            }

            // å•é¡Œã‚»ãƒƒãƒˆ
            state.questions = [...state.selectedGenre.items].sort(() => Math.random() - 0.5);
            state.qIndex = 0;
            state.correct = [];
            state.pass = [];

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
            switchScreen('countdown');
            let c = 3;
            $('count-number').innerText = c;
            playSound(440, 'sine', 0.1);

            const timer = setInterval(() => {
                c--;
                if(c > 0) {
                    $('count-number').innerText = c;
                    playSound(440, 'sine', 0.1);
                } else {
                    clearInterval(timer);
                    playSound(880, 'square', 0.3);
                    launchGame();
                }
            }, 1000);
        }

        // --- ã‚²ãƒ¼ãƒ æœ¬ç•ª ---
        let gameLoop;
        
        function launchGame() {
            // â˜…é‡è¦: ã‚²ãƒ¼ãƒ ç”»é¢ã¸åˆ‡ã‚Šæ›¿ãˆ
            switchScreen('game');
            state.isPlaying = true;
            state.timeLeft = state.time;
            state.motionState = 'neutral';
            
            updateGameUI();
            
            // ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–
            window.addEventListener('devicemotion', handleMotion);

            gameLoop = setInterval(() => {
                state.timeLeft--;
                updateGameUI();
                if(state.timeLeft <= 5) $('game-timer').classList.add('warning');
                
                if(state.timeLeft <= 0) finishGame();
            }, 1000);
        }

        function updateGameUI() {
            $('game-timer').innerText = state.timeLeft;
            $('game-score').innerText = state.correct.length;
            $('question-display').innerText = state.questions[state.qIndex] || 'çµ‚äº†';
        }

        // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³) ---
        function handleMotion(e) {
            if (!state.isPlaying) return;

            const z = e.accelerationIncludingGravity.z;
            if (z === null) return;

            // é–¾å€¤
            const TH_TRIGGER = 6.0; // å‚¾ã‘è§’åº¦ï¼ˆæ·±ã‚ï¼‰
            const TH_RESET = 2.5;   // æˆ»ã‚Šåˆ¤å®šï¼ˆå‚ç›´ä»˜è¿‘ï¼‰

            if (state.motionState === 'neutral') {
                // 1. å‚ç›´ã§å¾…æ©Ÿä¸­ -> å‚¾ãæ¤œçŸ¥
                if (z > TH_TRIGGER) {
                    doAnswer(true); // ä¸‹ï¼ˆæ­£è§£ï¼‰
                } else if (z < -TH_TRIGGER) {
                    doAnswer(false); // ä¸Šï¼ˆãƒ‘ã‚¹ï¼‰
                }
            } else if (state.motionState === 'triggered') {
                // 2. åˆ¤å®šå¾Œ -> å‚ç›´ã«æˆ»ã‚‹ã®ã‚’å¾…ã¤
                // ZãŒ -2.5 ~ 2.5 ã®é–“ã«æˆ»ã‚Œã°ãƒªã‚»ãƒƒãƒˆ
                if (z > -TH_RESET && z < TH_RESET) {
                    state.motionState = 'neutral';
                }
            }
        }

        function doAnswer(isCorrect) {
            state.motionState = 'triggered'; // ãƒ­ãƒƒã‚¯ã™ã‚‹

            const item = state.questions[state.qIndex];
            if (isCorrect) {
                state.correct.push(item);
                showFeedback('correct', 'æ­£è§£ï¼');
                playSound(1200, 'sine', 0.1);
            } else {
                state.pass.push(item);
                showFeedback('pass', 'ãƒ‘ã‚¹');
                playSound(300, 'triangle', 0.2);
            }

            // æ¬¡ã¸
            state.qIndex++;
            if (state.qIndex >= state.questions.length) state.qIndex = 0;

            setTimeout(() => {
                updateGameUI();
                $('feedback-overlay').classList.remove('show');
            }, 600);
        }

        function showFeedback(cls, text) {
            const el = $('feedback-overlay');
            el.className = `feedback-overlay show ${cls}`;
            $('fb-icon').innerText = cls === 'correct' ? 'â­•' : 'â­ï¸';
            $('fb-text').innerText = text;
        }

        // --- çµ‚äº† ---
        function finishGame() {
            state.isPlaying = false;
            clearInterval(gameLoop);
            window.removeEventListener('devicemotion', handleMotion);
            
            // ã‚«ãƒ¡ãƒ©åœæ­¢
            if($('camera-feed').srcObject) {
                $('camera-feed').srcObject.getTracks().forEach(t => t.stop());
            }
            
            playSound(600, 'sawtooth', 0.5);

            // çµæœè¡¨ç¤º
            $('result-number').innerText = state.correct.length;
            
            const renderList = (arr, icon, color) => {
                if(arr.length === 0) return '<div class="result-row">ãªã—</div>';
                return arr.map(t => `
                    <div class="result-row">
                        <span>${t}</span><span style="color:${color}">${icon}</span>
                    </div>
                `).join('');
            };

            $('result-list-correct').innerHTML = renderList(state.correct, 'â­•', 'var(--success)');
            $('result-list-pass').innerHTML = renderList(state.pass, 'â­ï¸', 'var(--warning)');
            
            switchScreen('result');
        }

        // Sound Utils
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, dur) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = type;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.stop(audioCtx.currentTime + dur);
        }
    </script>
</body>
</html>
