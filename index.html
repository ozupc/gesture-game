<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F4F8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Gesture Party 2025</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Outfit:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* 2025 Modern Light Palette */
            --bg-body: #F2F4F8;
            --surface: #FFFFFF;
            --surface-glass: rgba(255, 255, 255, 0.85);
            --text-main: #1A1C20;
            --text-sub: #8E939D;
            
            --primary: #4F46E5; /* Indigo */
            --primary-light: #EEF2FF;
            --accent: #F43F5E; /* Rose */
            --success: #10B981; /* Emerald */
            --warning: #F59E0B; /* Amber */
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.02), 0 1px 2px rgba(0,0,0,0.03);
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.04), 0 4px 6px -2px rgba(0,0,0,0.02);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.02);
            
            --radius-lg: 24px;
            --radius-md: 16px;
            
            --safe-top: max(20px, env(safe-area-inset-top));
            --safe-bottom: max(20px, env(safe-area-inset-bottom));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Outfit', 'M PLUS Rounded 1c', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            inset: 0;
        }

        /* --- ÂÖ±ÈÄö„É¨„Ç§„Ç¢„Ç¶„Éà --- */
        .screen {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            background: var(--bg-body);
            padding: var(--safe-top) 20px var(--safe-bottom) 20px;
            z-index: 10;
            transition: opacity 0.3s ease;
        }

        .screen.active { display: flex; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-top: 10px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-icon:active { transform: scale(0.9); }

        .scroll-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px; /* ‰∏ãÈÉ®„Éú„Çø„É≥Áî®‰ΩôÁôΩ */
            scrollbar-width: none;
        }
        .scroll-area::-webkit-scrollbar { display: none; }

        /* --- „Éõ„Éº„É†ÁîªÈù¢ (Bento Grid) --- */
        .bento-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .bento-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .bento-card:active { transform: scale(0.98); box-shadow: none; }
        
        .bento-card.full-width { grid-column: span 2; }

        .card-icon {
            font-size: 32px;
            margin-bottom: 12px;
            background: var(--bg-body);
            width: 60px;
            height: 60px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-label { font-size: 14px; color: var(--text-sub); font-weight: 700; margin-bottom: 4px; }
        .card-value { font-size: 20px; font-weight: 900; color: var(--text-main); line-height: 1.2; }

        .card-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-switch {
            width: 52px;
            height: 32px;
            background: var(--bg-body);
            border-radius: 20px;
            position: relative;
            transition: 0.3s;
        }
        .toggle-switch.active { background: var(--success); }
        .toggle-dot {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 4px; left: 4px;
            transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .toggle-switch.active .toggle-dot { transform: translateX(20px); }

        /* „Çπ„Çø„Éº„Éà„Éú„Çø„É≥ */
        .fab-start {
            position: fixed;
            bottom: var(--safe-bottom);
            left: 20px; right: 20px;
            height: 64px;
            background: var(--text-main);
            color: white;
            border-radius: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            box-shadow: var(--shadow-lg);
            border: none;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            z-index: 100;
        }
        .fab-start:disabled { background: #D1D5DB; cursor: not-allowed; box-shadow: none; }
        .fab-start:active { transform: scale(0.95); }

        /* --- „É™„Çπ„ÉàÈÅ∏Êäû --- */
        .list-item {
            background: var(--surface);
            margin-bottom: 12px;
            padding: 20px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700;
            box-shadow: var(--shadow-sm);
            transition: 0.2s;
        }
        .list-item.selected {
            border: 2px solid var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }

        /* --- „Ç≤„Éº„É†ÁîªÈù¢ (Ê≤°ÂÖ•„É¢„Éº„Éâ) --- */
        #game-screen {
            padding: 0;
            background: #000;
            color: white;
        }

        .camera-bg {
            position: absolute;
            inset: 0;
            object-fit: cover;
            width: 100%;
            height: 100%;
            opacity: 0.6;
            transform: scaleX(-1);
        }

        .game-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            padding: 20px var(--safe-right) 20px var(--safe-left);
        }

        .game-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
            font-weight: 900;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        .timer-pill {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 8px 20px;
            border-radius: 20px;
            font-variant-numeric: tabular-nums;
        }
        .timer-pill.urgent { background: rgba(244, 63, 94, 0.6); animation: pulse 1s infinite; }

        .question-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question-card {
            background: rgba(255,255,255,0.95);
            color: var(--text-main);
            padding: 40px;
            border-radius: 40px;
            width: 80%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            transform: rotate(-2deg); /* ÈÅä„Å≥ÂøÉ */
        }

        .q-text {
            font-size: clamp(32px, 8vw, 80px);
            font-weight: 900;
            line-height: 1.2;
            word-break: keep-all;
        }

        /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .feedback-flash {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
            z-index: 50;
        }
        .feedback-flash.correct { background: rgba(16, 185, 129, 0.9); }
        .feedback-flash.pass { background: rgba(245, 158, 11, 0.9); }
        .feedback-flash.show { opacity: 1; }
        
        .fb-emoji { font-size: 120px; margin-bottom: 20px; animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .fb-label { font-size: 48px; font-weight: 900; color: white; letter-spacing: 2px; }

        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

        /* --- „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ --- */
        .countdown-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .count-huge {
            font-size: 160px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- ÁµêÊûúÁîªÈù¢ --- */
        .result-header { text-align: center; margin-bottom: 30px; }
        .score-big { 
            font-size: 80px; font-weight: 900; color: var(--primary); line-height: 1;
            margin: 10px 0;
        }
        
        .result-list-label {
            font-size: 14px;
            color: var(--text-sub);
            font-weight: 700;
            margin: 20px 0 10px;
            text-transform: uppercase;
        }

        .result-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 500;
        }

        /* --- ÂõûËª¢Ë≠¶Âëä --- */
        .rotate-alert {
            position: fixed;
            inset: 0;
            background: var(--surface);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }
        @media (orientation: portrait) { .rotate-alert { display: flex; } }

        /* --- „É¢„Éº„ÉÄ„É´ --- */
        .modal-glass {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-box {
            background: var(--surface);
            padding: 32px;
            border-radius: var(--radius-lg);
            text-align: center;
            max-width: 320px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }
        .modal-btn {
            background: var(--text-main);
            color: white;
            border: none;
            padding: 16px;
            width: 100%;
            border-radius: 16px;
            font-weight: 700;
            margin-top: 24px;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <!-- Á∏¶ÁîªÈù¢Ë≠¶Âëä -->
    <div class="rotate-alert">
        <div style="font-size:64px; margin-bottom:20px;">üì±</div>
        <h2 style="font-size:24px; margin-bottom:10px;">„Çπ„Éû„Éõ„ÇíÊ®™„Å´„Åó„Å¶„Å≠</h2>
        <p style="color:var(--text-sub);">„Åì„ÅÆ„Ç≤„Éº„É†„ÅØÊ®™ÁîªÈù¢Â∞ÇÁî®„Åß„Åô„ÄÇ<br>ÂõûËª¢„Åï„Åõ„Å¶„Éó„É¨„Ç§„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
    </div>

    <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
    <div id="screen-home" class="screen active">
        <div class="header">
            <h1>Gesture Party</h1>
            <button class="btn-icon">‚öôÔ∏è</button>
        </div>

        <div class="scroll-area">
            <div class="bento-grid">
                <!-- „Ç∏„É£„É≥„É´ÈÅ∏Êäû„Ç´„Éº„Éâ -->
                <div class="bento-card full-width" onclick="openGenre()">
                    <div>
                        <div class="card-icon" style="color:#F59E0B; background:#FEF3C7;">üìÅ</div>
                        <div class="card-label">CURRENT GENRE</div>
                        <div class="card-value" id="disp-genre">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                    <div style="text-align:right; font-size:24px; color:var(--text-sub);">‚Üí</div>
                </div>

                <!-- ÊôÇÈñìÈÅ∏Êäû„Ç´„Éº„Éâ -->
                <div class="bento-card" onclick="openTime()">
                    <div class="card-icon" style="color:#10B981; background:#D1FAE5;">‚è±Ô∏è</div>
                    <div>
                        <div class="card-label">TIME LIMIT</div>
                        <div class="card-value" id="disp-time">60Áßí</div>
                    </div>
                </div>

                <!-- Èå≤Áîª„Çπ„Ç§„ÉÉ„ÉÅ„Ç´„Éº„Éâ -->
                <div class="bento-card" onclick="toggleRec()">
                    <div class="card-toggle">
                        <div class="card-icon" style="color:#F43F5E; background:#FFE4E6; margin:0;">üìπ</div>
                        <div class="toggle-switch" id="sw-rec">
                            <div class="toggle-dot"></div>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <div class="card-label">RECORDING</div>
                        <div class="card-value" id="disp-rec">OFF</div>
                    </div>
                </div>
            </div>
        </div>

        <button id="btn-start" class="fab-start" disabled>GAME START</button>
    </div>

    <!-- „Ç∏„É£„É≥„É´ÈÅ∏Êäû -->
    <div id="screen-genre" class="screen">
        <div class="header">
            <button class="btn-icon" onclick="goHome()">‚Üê</button>
            <h2 style="font-size:20px;">Genre</h2>
            <div style="width:44px;"></div>
        </div>
        <div class="scroll-area" id="list-genre"></div>
    </div>

    <!-- ÊôÇÈñìÈÅ∏Êäû -->
    <div id="screen-time" class="screen">
        <div class="header">
            <button class="btn-icon" onclick="goHome()">‚Üê</button>
            <h2 style="font-size:20px;">Time Limit</h2>
            <div style="width:44px;"></div>
        </div>
        <div class="scroll-area" id="list-time"></div>
    </div>

    <!-- „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ -->
    <div id="screen-count" class="screen">
        <div class="countdown-wrap">
            <div class="count-huge" id="count-num">3</div>
            <p style="margin-top:20px; font-weight:700; color:var(--text-sub);">„Çπ„Éû„Éõ„ÇíÂûÇÁõ¥„Å´Êßã„Åà„Å¶ÔºÅ</p>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
    <div id="game-screen" class="screen">
        <video id="video-bg" class="camera-bg" autoplay playsinline muted></video>
        
        <div class="game-overlay">
            <div class="game-top">
                <div class="timer-pill" id="timer">60</div>
                <div style="background:rgba(0,0,0,0.5); padding:8px 16px; border-radius:16px;">
                    Score: <span id="score">0</span>
                </div>
            </div>

            <div class="question-wrapper">
                <div class="question-card">
                    <div class="q-text" id="question">Ready?</div>
                </div>
            </div>

            <p style="text-align:center; font-size:14px; opacity:0.8; margin-top:20px;">
                ‰∏ã„ÇíÂêë„Åè ‚§µÔ∏è Ê≠£Ëß£„ÄÄ|„ÄÄ‰∏ä„ÇíÂêë„Åè ‚§¥Ô∏è „Éë„Çπ
            </p>
        </div>

        <div id="feedback" class="feedback-flash">
            <div class="fb-emoji" id="fb-icon">üéâ</div>
            <div class="fb-label" id="fb-text">PERFECT!</div>
        </div>
    </div>

    <!-- ÁµêÊûúÁîªÈù¢ -->
    <div id="screen-result" class="screen">
        <div class="scroll-area">
            <div class="result-header">
                <div style="font-size:14px; font-weight:700; color:var(--text-sub);">TOTAL SCORE</div>
                <div class="score-big" id="res-score">0</div>
                <div style="font-weight:700;">Amazing Job! üéâ</div>
            </div>

            <div class="result-list-label">CORRECT ANSWERS</div>
            <div id="list-correct"></div>

            <div class="result-list-label">PASSED</div>
            <div id="list-pass"></div>
        </div>
        <button class="fab-start" style="position:relative; bottom:0; margin-top:20px;" onclick="goHome()">BACK HOME</button>
    </div>

    <!-- Ë®±ÂèØ„É¢„Éº„ÉÄ„É´ -->
    <div id="modal-perm" class="modal-glass">
        <div class="modal-box">
            <div style="font-size:48px; margin-bottom:16px;">üéÆ</div>
            <h3 style="font-size:20px; font-weight:900;">„Çª„É≥„Çµ„ÉºË®±ÂèØ</h3>
            <p style="color:var(--text-sub); margin-top:8px; line-height:1.5;">„Ç≤„Éº„É†„Çí„Éó„É¨„Ç§„Åô„Çã„Å´„ÅØ„ÄÅÂÇæ„ÅçÊ§úÁü•„Çª„É≥„Çµ„Éº„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ</p>
            <button class="modal-btn" onclick="grantPerm()">OK, Ë®±ÂèØ„Åô„Çã</button>
        </div>
    </div>

    <script>
        // --- „Éá„Éº„Çø„ÅÆÂÆåÂÖ®Âüã„ÇÅËæº„Åø („Åì„Çå„ÅßÁµ∂ÂØæ„Å´Ê∂à„Åà„Å™„ÅÑ) ---
        const DATABASE = [
            {
                id: 'animals', name: 'ÂãïÁâ©', icon: 'üêò',
                items: ['„É©„Ç§„Ç™„É≥', '„Ç≠„É™„É≥', '„Çæ„Ç¶', '„Éö„É≥„ÇÆ„É≥', '„Éë„É≥„ÉÄ', '„Ç≥„Ç¢„É©', '„Ç¥„É™„É©', '„Ç¶„Çµ„ÇÆ', '„Ç´„É°', '„Ç§„É´„Ç´', '„Ç´„É≥„Ç¨„É´„Éº', '„Éè„É†„Çπ„Çø„Éº', 'Áå´', 'Áä¨', '„Éã„ÉØ„Éà„É™', '„Éí„ÉÑ„Ç∏', '„Ç´„Éê', '„Ç∑„Éû„Ç¶„Éû']
            },
            {
                id: 'sports', name: '„Çπ„Éù„Éº„ÉÑ', icon: '‚öΩ',
                items: ['„Çµ„ÉÉ„Ç´„Éº', 'ÈáéÁêÉ', '„ÉÜ„Éã„Çπ', '„Éê„Çπ„Ç±', '„Éê„É¨„Éº„Éú„Éº„É´', 'Ê∞¥Ê≥≥', 'ÂçìÁêÉ', '„Ç¥„É´„Éï', '„Éú„ÇØ„Ç∑„É≥„Ç∞', 'ÊüîÈÅì', '„Çπ„Ç≠„Éº', '„Éï„Ç£„ÇÆ„É•„Ç¢„Çπ„Ç±„Éº„Éà', '„É©„Ç∞„Éì„Éº', 'Áõ∏Êí≤', '„Éû„É©„ÇΩ„É≥']
            },
            {
                id: 'food', name: 'È£ü„ÅπÁâ©', icon: 'üçî',
                items: ['„É©„Éº„É°„É≥', 'ÂØøÂè∏', '„Ç´„É¨„Éº„É©„Ç§„Çπ', '„Éè„É≥„Éê„Éº„Ç¨„Éº', '„Éî„Ç∂', '„Åü„ÅìÁÑº„Åç', '„Ç™„É†„É©„Ç§„Çπ', '„Çπ„ÉÜ„Éº„Ç≠', 'ÁÑºËÇâ', '„Ç¢„Ç§„Çπ„ÇØ„É™„Éº„É†', '„Éë„É≥„Ç±„Éº„Ç≠', '„Åä„Å´„Åé„Çä', 'Á¥çË±Ü', 'È§ÉÂ≠ê']
            },
            {
                id: 'jobs', name: 'ËÅ∑Ê•≠', icon: 'üëÆ',
                items: ['„ÅäÂåªËÄÖ„Åï„Çì', 'Ë≠¶ÂØüÂÆò', 'Ê∂àÈò≤Â£´', '„Ç¢„Ç§„Éâ„É´', 'YouTuber', '„Çµ„ÉÉ„Ç´„ÉºÈÅ∏Êâã', 'Â≠¶Ê†°„ÅÆÂÖàÁîü', '„Éë„Ç§„É≠„ÉÉ„Éà', 'Â§ßÂ∑•„Åï„Çì', 'ÊñôÁêÜ‰∫∫', '„Ç≥„É≥„Éì„ÉãÂ∫óÂì°', 'ÁæéÂÆπÂ∏´', '„É¢„Éá„É´']
            },
            {
                id: 'actions', name: 'Âãï‰Ωú', icon: 'üíÉ',
                items: ['Ê≠ØÁ£®„Åç', 'ÈõªË©±', 'ÂØù„Çã', 'Ëµ∞„Çã', 'Ê≥£„Åè', 'Á¨ë„ÅÜ', 'ÊÄí„Çã', 'Ê≠å„ÅÜ', '„ÉÄ„É≥„Çπ', 'Ë™≠Êõ∏', 'Ëá™ÊíÆ„Çä', 'ÈÅãËª¢', 'ÊñôÁêÜ', 'ÊéÉÈô§', 'ÂåñÁ≤ß', '„Ç≤„Éº„É†']
            }
        ];

        // --- Áä∂ÊÖãÁÆ°ÁêÜ ---
        const state = {
            genre: null,
            time: 60,
            rec: false,
            items: [],
            qIndex: 0,
            correct: [],
            pass: [],
            timeLeft: 0,
            playing: false,
            cooldown: false,
            permitted: false
        };

        // --- DOMË¶ÅÁ¥†„Éò„É´„Éë„Éº ---
        const $ = id => document.getElementById(id);
        const showScreen = id => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            $(id).classList.add('active');
        };

        // --- „Çµ„Ç¶„É≥„Éâ„Ç®„É≥„Ç∏„É≥ ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playTone = (freq, type, dur) => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = type;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.stop(audioCtx.currentTime + dur);
        };

        const sfx = {
            ok: () => { playTone(880, 'sine', 0.1); setTimeout(()=>playTone(1760, 'sine', 0.2), 0.1); },
            pass: () => playTone(300, 'triangle', 0.3),
            count: () => playTone(500, 'sine', 0.1),
            start: () => playTone(1200, 'square', 0.6),
            end: () => { playTone(400, 'sawtooth', 0.2); setTimeout(()=>playTone(300, 'sawtooth', 0.4), 0.2); }
        };

        // --- ÂàùÊúüÂåñ & „É´„Éº„ÉÜ„Ç£„É≥„Ç∞ ---
        function init() {
            // „Éõ„Éº„É†ÁîªÈù¢„ÅÆUI„Ç§„Éô„É≥„ÉàË®≠ÂÆö
            $('btn-start').onclick = preGameCheck;
            
            // „Ç∏„É£„É≥„É´„É™„Çπ„ÉàÁîüÊàê
            $('list-genre').innerHTML = DATABASE.map(g => `
                <div class="list-item" onclick="setGenre('${g.id}')">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span style="font-size:24px;">${g.icon}</span>
                        <span>${g.name}</span>
                    </div>
                    ${state.genre?.id === g.id ? '‚úÖ' : ''}
                </div>
            `).join('');

            // ÊôÇÈñì„É™„Çπ„ÉàÁîüÊàê
            const times = [30, 60, 90, 120];
            $('list-time').innerHTML = times.map(t => `
                <div class="list-item" onclick="setTime(${t})">
                    <span>${t}Áßí</span>
                    ${state.time === t ? '‚úÖ' : ''}
                </div>
            `).join('');
        }

        // --- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Èñ¢Êï∞ ---
        window.goHome = () => showScreen('screen-home');
        window.openGenre = () => showScreen('screen-genre');
        window.openTime = () => showScreen('screen-time');

        window.setGenre = (id) => {
            state.genre = DATABASE.find(d => d.id === id);
            $('disp-genre').innerText = state.genre.name;
            $('btn-start').disabled = false;
            init(); // ÂÜçÊèèÁîª
            goHome();
        };

        window.setTime = (t) => {
            state.time = t;
            $('disp-time').innerText = t + 'Áßí';
            init();
            goHome();
        };

        window.toggleRec = () => {
            state.rec = !state.rec;
            const sw = $('sw-rec');
            if(state.rec) {
                sw.classList.add('active');
                $('disp-rec').innerText = 'ON';
                $('disp-rec').style.color = 'var(--success)';
            } else {
                sw.classList.remove('active');
                $('disp-rec').innerText = 'OFF';
                $('disp-rec').style.color = 'var(--text-main)';
            }
        };

        // --- „Ç≤„Éº„É†ÈñãÂßã„Éï„É≠„Éº ---
        function preGameCheck() {
            // AndroidÂêë„Åë„Éï„É´„Çπ„ÇØ„É™„Éº„É≥
            if(document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(()=>{});
            }

            if(typeof DeviceMotionEvent !== 'undefined' && 
               typeof DeviceMotionEvent.requestPermission === 'function' && 
               !state.permitted) {
                $('modal-perm').style.display = 'flex';
            } else {
                startCountdown();
            }
        }

        window.grantPerm = () => {
            DeviceMotionEvent.requestPermission()
                .then(res => {
                    if(res === 'granted') {
                        state.permitted = true;
                        $('modal-perm').style.display = 'none';
                        startCountdown();
                    } else {
                        alert('Ë®≠ÂÆö„Åã„Çâ„Çª„É≥„Çµ„Éº„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    }
                })
                .catch(() => {
                    // AndroidÁ≠â„ÅØ„Åì„Åì
                    state.permitted = true;
                    $('modal-perm').style.display = 'none';
                    startCountdown();
                });
        };

        function startCountdown() {
            // „Ç´„É°„É©Ê∫ñÂÇô
            if(state.rec) {
                navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false})
                    .then(s => $('video-bg').srcObject = s)
                    .catch(e => console.log(e));
            } else {
                $('video-bg').srcObject = null;
            }

            showScreen('screen-count');
            let c = 3;
            $('count-num').innerText = c;
            sfx.count();

            let t = setInterval(() => {
                c--;
                if(c > 0) {
                    $('count-num').innerText = c;
                    sfx.count();
                } else {
                    clearInterval(t);
                    startGame();
                }
            }, 1000);
        }

        // --- „Ç≤„Éº„É†Êú¨‰Ωì ---
        let gameInterval;
        
        function startGame() {
            state.items = [...state.genre.items].sort(() => Math.random() - 0.5);
            state.qIndex = 0;
            state.correct = [];
            state.pass = [];
            state.timeLeft = state.time;
            state.playing = true;
            state.cooldown = false;

            showScreen('game-screen');
            sfx.start();
            updateUI();
            
            // Âä†ÈÄüÂ∫¶„Çª„É≥„Çµ„Éº (ÈáçÂäõÊ§úÁü•)
            window.addEventListener('devicemotion', handleMotion);

            gameInterval = setInterval(() => {
                state.timeLeft--;
                updateUI();
                if(state.timeLeft <= 5) $('timer').classList.add('urgent');
                else $('timer').classList.remove('urgent');

                if(state.timeLeft <= 0) finishGame();
            }, 1000);
        }

        function updateUI() {
            $('timer').innerText = state.timeLeft;
            $('score').innerText = state.correct.length;
            $('question').innerText = state.items[state.qIndex] || 'ÁµÇ‰∫Ü';
        }

        // --- Âà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ (ZËª∏ÈáçÂäõ) ---
        function handleMotion(e) {
            if(!state.playing || state.cooldown) return;

            const z = e.accelerationIncludingGravity?.z || 0;

            // Z > 6.0: ÁîªÈù¢„ÅåÂú∞Èù¢„Å´Âêë„ÅÑ„Å¶„ÅÑ„Çã (Ê≠£Ëß£)
            // Z < -6.0: ÁîªÈù¢„ÅåÁ©∫„Å´Âêë„ÅÑ„Å¶„ÅÑ„Çã („Éë„Çπ)
            
            if (z > 6.0) {
                processAnswer(true);
            } else if (z < -6.0) {
                processAnswer(false);
            }
        }

        function processAnswer(isCorrect) {
            state.cooldown = true;
            const item = state.items[state.qIndex];

            if(isCorrect) {
                state.correct.push(item);
                sfx.ok();
                showFeedback(true);
            } else {
                state.pass.push(item);
                sfx.pass();
                showFeedback(false);
            }

            setTimeout(() => {
                state.qIndex++;
                if(state.qIndex >= state.items.length) state.qIndex = 0;
                updateUI();
                hideFeedback();
                
                // ÂûÇÁõ¥„Å´Êàª„Åô„Åü„ÇÅ„ÅÆ‰ΩôË£ï
                setTimeout(() => { state.cooldown = false; }, 800);
            }, 600);
        }

        function showFeedback(isCorrect) {
            const fb = $('feedback');
            fb.className = `feedback-flash show ${isCorrect ? 'correct' : 'pass'}`;
            $('fb-icon').innerText = isCorrect ? 'üéâ' : 'üí®';
            $('fb-text').innerText = isCorrect ? 'NICE!' : 'PASS';
        }
        function hideFeedback() { $('feedback').classList.remove('show'); }

        // --- ÁµêÊûúÁîªÈù¢ ---
        function finishGame() {
            state.playing = false;
            clearInterval(gameInterval);
            window.removeEventListener('devicemotion', handleMotion);
            
            const vid = $('video-bg');
            if(vid.srcObject) vid.srcObject.getTracks().forEach(t => t.stop());

            sfx.end();
            
            $('res-score').innerText = state.correct.length;
            
            // ÁµêÊûú„É™„Çπ„ÉàÊèèÁîª
            $('list-correct').innerHTML = state.correct.length ? 
                state.correct.map(i => `<div class="result-item" style="color:var(--success)">‚úÖ ${i}</div>`).join('') : 
                '<div style="color:#ccc; padding:10px;">„Å™„Åó</div>';
                
            $('list-pass').innerHTML = state.pass.length ? 
                state.pass.map(i => `<div class="result-item" style="color:var(--warning)">üí® ${i}</div>`).join('') : 
                '<div style="color:#ccc; padding:10px;">„Å™„Åó</div>';

            showScreen('screen-result');
        }

        // „Çπ„Çø„Éº„Éà
        init();

    </script>
</body>
</html>
