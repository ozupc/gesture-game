<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚²ãƒ¼ãƒ </title>
    <style>
        :root {
            --bg: #121212;
            --text: #ffffff;
            --accent: #0A84FF;
            --success: #30D158;
            --pass: #FF9F0A;
            --danger: #FF453A;
            --card-bg: #1C1C1E;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
            --safe-right: env(safe-area-inset-right);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            /* ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­–ã®ã‚­ãƒ¢: å‹•çš„é«˜ã•(dvh)ã§å›ºå®šã—ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            inset: 0;
        }

        /* ç”»é¢å…±é€šè¨­å®š */
        .screen {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            background: var(--bg);
            padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
            z-index: 10;
        }

        .screen.active { display: flex; }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        h1 { font-size: 28px; margin: 20px 0 10px; text-align: center; }
        
        .menu-card {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .menu-btn {
            width: 100%;
            padding: 16px;
            background: none;
            border: none;
            border-bottom: 1px solid #333;
            color: white;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .menu-btn:last-child { border-bottom: none; }
        .menu-btn:active { background: #333; }
        .val { color: var(--accent); font-weight: bold; }

        /* æ”¹å–„ã•ã‚ŒãŸéŒ²ç”»ãƒœã‚¿ãƒ³ */
        .rec-btn-large {
            width: 100%;
            padding: 16px;
            margin-top: 10px;
            border-radius: 12px;
            border: 2px solid #333;
            background: var(--card-bg);
            color: #888;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
        }
        .rec-btn-large.active {
            border-color: var(--danger);
            background: rgba(255, 69, 58, 0.1);
            color: var(--danger);
        }
        .rec-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #555;
        }
        .rec-btn-large.active .rec-dot { background: var(--danger); }

        .btn-start {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
            padding: 18px;
            background: var(--accent);
            color: white;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
            cursor: pointer;
        }
        .btn-start:disabled { background: #444; color: #888; box-shadow: none; }
        .btn-start:active { transform: scale(0.98); }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆå®Œå…¨å›ºå®šãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ï¼‰ */
        #game-screen {
            background: #000;
            overflow: hidden;
        }

        .camera-feed {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.4;
            z-index: 0;
        }

        .game-ui {
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            flex-direction: column;
            /* ç”»é¢ç«¯ã®èª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ã®ä½™ç™½ */
            padding: 10px 40px; 
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px black;
        }
        .timer-box.urgent { color: var(--danger); animation: pulse 0.5s infinite; }

        .question-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .q-text {
            font-size: clamp(40px, 15vw, 110px);
            font-weight: 800;
            text-align: center;
            line-height: 1.1;
            text-shadow: 0 4px 10px black;
            word-break: keep-all;
        }

        /* åˆ¤å®šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        .feedback {
            position: absolute;
            inset: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.85);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
        }
        .feedback.show { opacity: 1; }
        .feedback.correct { background: rgba(48, 209, 88, 0.9); }
        .feedback.pass { background: rgba(255, 159, 10, 0.9); }
        .fb-icon { font-size: 100px; margin-bottom: 20px; }
        .fb-text { font-size: 40px; font-weight: bold; color: white; }

        /* ã‚¬ã‚¤ãƒ‰ãƒ»è­¦å‘Š */
        .guide-text {
            position: absolute;
            bottom: 20px;
            right: 20px;
            text-align: right;
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            line-height: 1.6;
        }
        
        #rotate-warning {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        @media (orientation: portrait) { #rotate-warning { display: flex; } }

        /* ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .list-row {
            padding: 15px;
            background: var(--card-bg);
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
        }
        .list-row.selected { color: var(--accent); }

        /* ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒãƒƒã‚° */
        #debug {
            position: absolute;
            bottom: 5px; left: 5px;
            font-size: 10px; color: lime;
            z-index: 100;
            font-family: monospace;
            display: none;
        }
    </style>
</head>
<body>

    <!-- ç¸¦ç”»é¢è­¦å‘Š -->
    <div id="rotate-warning">
        <div style="font-size:50px;">ğŸ“±</div>
        <p style="margin-top:15px; font-weight:bold;">ã‚¹ãƒãƒ›ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„</p>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="screen-home" class="screen active">
        <div class="content-scroll">
            <h1>ğŸ­ ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚²ãƒ¼ãƒ </h1>
            <p style="color:#888; margin-bottom:30px;">ã‚¹ãƒãƒ›ã‚’ãŠã§ã“ã«å½“ã¦ã¦å‚ç›´ã«æ§‹ãˆã¾ã™</p>

            <div class="menu-card">
                <button class="menu-btn" onclick="openGenre()">
                    <span>ğŸ“ ã‚¸ãƒ£ãƒ³ãƒ«</span>
                    <span class="val" id="val-genre">æœªé¸æŠ</span>
                </button>
                <button class="menu-btn" onclick="openTime()">
                    <span>â±ï¸ åˆ¶é™æ™‚é–“</span>
                    <span class="val" id="val-time">60ç§’</span>
                </button>
            </div>

            <button id="btn-rec" class="rec-btn-large" onclick="toggleRec()">
                <div class="rec-dot"></div>
                <span id="txt-rec">éŒ²ç”»ã—ãªã„</span>
            </button>

            <button id="btn-start" class="btn-start" disabled onclick="tryStart()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            
            <div style="margin-top:30px; font-size:12px; color:#555;" onclick="toggleDebug()">
                Ver 3.0 (Gravity Logic)
            </div>
            
            <!-- iOSå‘ã‘PWAãƒ’ãƒ³ãƒˆ -->
            <div id="ios-hint" style="display:none; margin-top:20px; background:#222; padding:15px; border-radius:10px; font-size:13px; color:#aaa;">
                ğŸ’¡ ç”»é¢ã®ã‚¿ãƒ–ãŒé‚ªé­”ãªå ´åˆ<br>
                ãƒ–ãƒ©ã‚¦ã‚¶ã®[å…±æœ‰]ãƒœã‚¿ãƒ³ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’è¡Œã†ã¨å…¨ç”»é¢ã§éŠã¹ã¾ã™ã€‚
            </div>
        </div>
    </div>

    <!-- è¨­å®šç”»é¢ -->
    <div id="screen-list" class="screen">
        <div style="padding:10px; display:flex; align-items:center;">
            <button onclick="goHome()" style="background:none; border:none; color:var(--accent); font-size:16px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <span style="flex:1; text-align:center; font-weight:bold;" id="list-title">è¨­å®š</span>
            <span style="width:60px;"></span>
        </div>
        <div class="content-scroll" id="list-content"></div>
    </div>

    <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
    <div id="screen-count" class="screen" style="justify-content:center; align-items:center;">
        <div style="font-size:120px; font-weight:bold; color:var(--accent);" id="count-num">3</div>
        <p style="color:#888; margin-top:20px;">ã‚¹ãƒãƒ›ã‚’å‚ç›´ã«æ§‹ãˆã¦ãã ã•ã„</p>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="game-screen" class="screen">
        <video id="video-bg" class="camera-feed" autoplay playsinline muted></video>
        <div class="game-ui">
            <div class="game-header">
                <div class="timer-box" id="timer">60</div>
                <div>æ­£è§£: <span id="score">0</span></div>
            </div>
            <div class="question-area">
                <div class="q-text" id="question">Ready?</div>
            </div>
            <div class="guide-text">
                ç”»é¢ã‚’ä¸‹(åœ°é¢)ã¸ â†’ æ­£è§£<br>
                ç”»é¢ã‚’ä¸Š(ç©º)ã¸ â†’ ãƒ‘ã‚¹
            </div>
        </div>
        <div id="feedback" class="feedback">
            <div class="fb-icon" id="fb-icon">â­•</div>
            <div class="fb-text" id="fb-text">æ­£è§£ï¼</div>
        </div>
        <div id="debug">Wait...</div>
    </div>

    <!-- çµæœç”»é¢ -->
    <div id="screen-result" class="screen">
        <div class="content-scroll">
            <h2>çµæœç™ºè¡¨</h2>
            <div style="font-size:60px; font-weight:bold; color:var(--accent); margin:20px;">
                <span id="res-score">0</span><span style="font-size:24px; color:white;"> å•</span>
            </div>
            <button class="btn-start" onclick="goHome()" style="background:#333; margin-bottom:20px;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
            
            <div style="width:100%; max-width:600px;">
                <h3 style="color:#888; font-size:14px; margin:10px;">æ­£è§£</h3>
                <div id="list-correct"></div>
                <h3 style="color:#888; font-size:14px; margin:20px 0 10px;">ãƒ‘ã‚¹</h3>
                <div id="list-pass"></div>
            </div>
        </div>
    </div>

    <!-- è¨±å¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-perm" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; display:none; justify-content:center; align-items:center;">
        <div style="background:#1C1C1E; padding:30px; border-radius:20px; text-align:center; max-width:300px;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ“±</div>
            <h3 style="margin-bottom:10px;">ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯</h3>
            <p style="font-size:14px; color:#aaa; margin-bottom:20px;">ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã«ã¯å‚¾ãã‚»ãƒ³ã‚µãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</p>
            <button onclick="grantPerm()" class="btn-start" style="margin-top:0;">è¨±å¯ã™ã‚‹</button>
        </div>
    </div>

    <script>
        // --- è¨­å®š ---
        const GENRES = [
            {id:'animals.json', name:'å‹•ç‰©', icon:'ğŸ¾'},
            {id:'sports.json', name:'ã‚¹ãƒãƒ¼ãƒ„', icon:'âš½'},
            {id:'food.json', name:'é£Ÿã¹ç‰©', icon:'ğŸ£'},
            {id:'jobs.json', name:'è·æ¥­', icon:'ğŸ‘®'},
            {id:'actions.json', name:'å‹•ä½œ', icon:'ğŸ’ƒ'}
        ];

        // --- çŠ¶æ…‹ç®¡ç† ---
        let state = {
            genre: null,
            time: 60,
            rec: false,
            items: [],
            index: 0,
            correct: [],
            pass: [],
            timeLeft: 0,
            playing: false,
            cooldown: false,
            permitted: false
        };

        // --- DOMè¦ç´  ---
        const $ = id => document.getElementById(id);
        const screens = ['home', 'list', 'count', 'game', 'result'];
        const showScreen = name => {
            screens.forEach(s => $(`screen-${s}`).classList.remove('active'));
            $(`screen-${name}`).classList.add('active');
        };

        // --- åˆæœŸåŒ– ---
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if(isIOS && !window.navigator.standalone) $('ios-hint').style.display = 'block';

        // --- è¨­å®šæ“ä½œ ---
        function openGenre() {
            $('list-title').innerText = 'ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ';
            $('list-content').innerHTML = GENRES.map(g => `
                <div class="list-row ${state.genre?.id === g.id ? 'selected' : ''}" 
                     onclick="setGenre('${g.id}')">
                    <span>${g.icon} ${g.name}</span>
                    <span>${state.genre?.id === g.id ? 'âœ”' : ''}</span>
                </div>
            `).join('');
            showScreen('list');
        }

        async function setGenre(id) {
            state.genre = GENRES.find(g => g.id === id);
            $('val-genre').innerText = state.genre.name;
            try {
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const res = await fetch(`data/${id}`);
                const data = await res.json();
                state.items = data.items;
                $('btn-start').disabled = false;
                goHome();
            } catch(e) {
                alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ\n' + e);
            }
        }

        function openTime() {
            $('list-title').innerText = 'åˆ¶é™æ™‚é–“';
            const times = [30, 60, 90, 120, 180];
            $('list-content').innerHTML = times.map(t => `
                <div class="list-row ${state.time === t ? 'selected' : ''}" 
                     onclick="setTime(${t})">
                    <span>${t}ç§’</span>
                    <span>${state.time === t ? 'âœ”' : ''}</span>
                </div>
            `).join('');
            showScreen('list');
        }

        function setTime(t) {
            state.time = t;
            $('val-time').innerText = t + 'ç§’';
            goHome();
        }

        function toggleRec() {
            state.rec = !state.rec;
            const btn = $('btn-rec');
            if(state.rec) {
                btn.classList.add('active');
                $('txt-rec').innerText = 'éŒ²ç”»ã™ã‚‹';
            } else {
                btn.classList.remove('active');
                $('txt-rec').innerText = 'éŒ²ç”»ã—ãªã„';
            }
        }

        function goHome() { showScreen('home'); }

        // --- ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ—ãƒ­ã‚»ã‚¹ ---
        function tryStart() {
            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è©¦è¡Œ (Androidå‘ã‘)
            if(document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(()=>{});
            }

            if(typeof DeviceMotionEvent !== 'undefined' && 
               typeof DeviceMotionEvent.requestPermission === 'function' && 
               !state.permitted) {
                $('modal-perm').style.display = 'flex';
            } else {
                startCount();
            }
        }

        function grantPerm() {
            DeviceMotionEvent.requestPermission().then(res => {
                if(res === 'granted') {
                    state.permitted = true;
                    $('modal-perm').style.display = 'none';
                    startCount();
                } else {
                    alert('è¨±å¯ãŒå¿…è¦ã§ã™');
                }
            }).catch(e => {
                console.error(e);
                // Androidç­‰ã¯ã“ã“
                state.permitted = true;
                $('modal-perm').style.display = 'none';
                startCount();
            });
        }

        // --- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ ---
        function startCount() {
            // ã‚«ãƒ¡ãƒ©èµ·å‹•
            if(state.rec) {
                navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false})
                .then(stream => $('video-bg').srcObject = stream)
                .catch(e => console.log('Camera fail', e));
            } else {
                $('video-bg').srcObject = null;
            }

            showScreen('count');
            let c = 3;
            $('count-num').innerText = c;
            playSound(440, 'sine');
            
            let timer = setInterval(() => {
                c--;
                if(c > 0) {
                    $('count-num').innerText = c;
                    playSound(440, 'sine');
                } else {
                    clearInterval(timer);
                    startGame();
                }
            }, 1000);
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ¡ã‚¤ãƒ³ ---
        let gameTimer;
        
        function startGame() {
            // å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
            state.items = state.items.sort(() => Math.random() - 0.5);
            state.index = 0;
            state.correct = [];
            state.pass = [];
            state.timeLeft = state.time;
            state.playing = true;
            state.cooldown = false;

            showScreen('game');
            playSound(880, 'square');
            updateUI();
            
            // ã‚»ãƒ³ã‚µãƒ¼é–‹å§‹ (DeviceMotion = åŠ é€Ÿåº¦/é‡åŠ›)
            window.addEventListener('devicemotion', handleMotion);

            gameTimer = setInterval(() => {
                state.timeLeft--;
                updateUI();
                if(state.timeLeft <= 5) $('timer').classList.add('urgent');
                else $('timer').classList.remove('urgent');

                if(state.timeLeft <= 0) finishGame();
            }, 1000);
        }

        function updateUI() {
            $('timer').innerText = state.timeLeft;
            $('score').innerText = state.correct.length;
            $('question').innerText = state.items[state.index] || 'çµ‚äº†';
        }

        // --- æ ¸å¿ƒï¼šé‡åŠ›ã«ã‚ˆã‚‹åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
        // å‚ç›´åŸºæº–ã«ã—ãŸã„å ´åˆã€åŠ é€Ÿåº¦(é‡åŠ›)ã‚’è¦‹ã‚‹ã®ãŒä¸€ç•ªç¢ºå®Ÿã§ã™ã€‚
        // accelerationIncludingGravity
        // Zè»¸: ç”»é¢ã¨å‚ç›´æ–¹å‘ã€‚ç”»é¢ãŒç©ºã‚’å‘ãã¨ãƒã‚¤ãƒŠã‚¹ã€åœ°é¢ã‚’å‘ãã¨ãƒ—ãƒ©ã‚¹ã€‚
        // Yè»¸/Xè»¸: ç”»é¢ã®ç¸¦æ¨ªæ–¹å‘ã€‚å‚ç›´ã«ç«‹ã¦ã‚‹ã¨ã©ã¡ã‚‰ã‹ãŒ9.8ã«ãªã‚‹ã€‚
        function handleMotion(e) {
            if(!state.playing || state.cooldown) return;

            const acc = e.accelerationIncludingGravity;
            if(!acc) return;

            const z = acc.z || 0;
            // Debug
            $('debug').innerText = `Z: ${z.toFixed(1)}`;

            // åˆ¤å®šé–¾å€¤ (m/s^2)
            // ZãŒç´„9.8ãªã‚‰ç”»é¢ã¯çœŸä¸‹(åœ°é¢)ã€‚
            // ZãŒç´„-9.8ãªã‚‰ç”»é¢ã¯çœŸä¸Š(ç©º)ã€‚
            // ZãŒç´„0ãªã‚‰ç”»é¢ã¯å‚ç›´ã€‚

            // 1. æ­£è§£åˆ¤å®š (ç”»é¢ã‚’åœ°é¢ã«å‘ã‘ã‚‹)
            // å°‘ã—å‚¾ã‘ãŸã ã‘ã§åå¿œã™ã‚‹ã‚ˆã†ã« z > 6 ãã‚‰ã„ (å‚ç›´ã¯0~2ãã‚‰ã„)
            if (z > 6.0) { 
                answer(true);
            }
            // 2. ãƒ‘ã‚¹åˆ¤å®š (ç”»é¢ã‚’ç©ºã«å‘ã‘ã‚‹)
            // ãŠã§ã“ã«ä¹—ã›ãŸã¾ã¾ç©ºã«å‘ã‘ã‚‹ -> z < -6
            else if (z < -6.0) {
                answer(false);
            }
        }

        function answer(isCorrect) {
            state.cooldown = true;
            const item = state.items[state.index];

            if(isCorrect) {
                state.correct.push(item);
                playSound(1200, 'sine'); // ãƒ”ãƒ³ãƒãƒ³
                showFeedback('correct', 'â­• æ­£è§£ï¼');
            } else {
                state.pass.push(item);
                playSound(300, 'triangle'); // ãƒ–ãƒ–ãƒ¼
                showFeedback('pass', 'â­ï¸ ãƒ‘ã‚¹');
            }

            // æ¬¡ã®å•é¡Œã¸
            setTimeout(() => {
                state.index++;
                if(state.index >= state.items.length) state.index = 0;
                updateUI();
                hideFeedback();

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚ç›´(ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«)ã«æˆ»ã™ã®ã‚’å¾…ã¤
                // å˜ç´”ãªã‚¿ã‚¤ãƒãƒ¼ã§ã¯ãªãã€Zè»¸ãŒ0ä»˜è¿‘ã«æˆ»ã‚‹ã®ã‚’å¾…ã¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨å®Œç’§ã ãŒã€
                // ç°¡æ˜“çš„ã«1ç§’å¾…æ©Ÿã§ååˆ†å®Ÿç”¨çš„
                setTimeout(() => {
                    state.cooldown = false;
                }, 800);
            }, 500);
        }

        function showFeedback(cls, text) {
            $('feedback').className = `feedback show ${cls}`;
            $('fb-icon').innerText = cls === 'correct' ? 'â­•' : 'â­ï¸';
            $('fb-text').innerText = text;
        }
        function hideFeedback() {
            $('feedback').classList.remove('show');
        }

        // --- ã‚²ãƒ¼ãƒ çµ‚äº† ---
        function finishGame() {
            state.playing = false;
            clearInterval(gameTimer);
            window.removeEventListener('devicemotion', handleMotion);
            
            // ã‚«ãƒ¡ãƒ©åœæ­¢
            const vid = $('video-bg');
            if(vid.srcObject) {
                vid.srcObject.getTracks().forEach(t => t.stop());
            }

            playSound(600, 'sawtooth');
            
            // çµæœè¡¨ç¤º
            $('res-score').innerText = state.correct.length;
            $('list-correct').innerHTML = state.correct.map(t => `<div style="padding:5px; border-bottom:1px solid #333;">${t}</div>`).join('');
            $('list-pass').innerHTML = state.pass.map(t => `<div style="padding:5px; border-bottom:1px solid #333;">${t}</div>`).join('');
            
            showScreen('result');
        }

        // --- ç°¡æ˜“ã‚µã‚¦ãƒ³ãƒ‰ ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = type;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.stop(audioCtx.currentTime + 0.2);
        }
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨
        let dbgCount = 0;
        function toggleDebug() {
            dbgCount++;
            if(dbgCount > 5) $('debug').style.display = 'block';
        }

    </script>
</body>
</html>
