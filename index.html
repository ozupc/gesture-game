<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#F2F2F7">
    <title>Gesture Game 2025</title>
    <style>
        :root {
            /* iOS Light Mode Colors */
            --bg-body: #F2F2F7;       /* System Grouped Background */
            --bg-card: #FFFFFF;       /* Secondary Grouped Background */
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --accent: #007AFF;        /* System Blue */
            --success: #34C759;       /* System Green */
            --warning: #FF9500;       /* System Orange */
            --danger: #FF3B30;        /* System Red */
            --separator: #C6C6C8;
            
            --radius-l: 12px;
            --radius-m: 10px;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            inset: 0;
        }

        /* ç”»é¢é·ç§»ã‚³ãƒ³ãƒ†ãƒŠ */
        .screen {
            position: absolute;
            inset: 0;
            background: var(--bg-body);
            display: none;
            flex-direction: column;
            z-index: 10;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        .screen.active { display: flex; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸ */
        .scroll-view {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header-large {
            padding: 20px 0 10px;
            text-align: left;
        }
        .header-large h1 {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .header-large p {
            color: var(--text-secondary);
            font-size: 15px;
            margin-top: 4px;
        }

        /* iOSé¢¨ãƒªã‚¹ãƒˆï¼ˆInset Groupedï¼‰ */
        .list-group {
            background: var(--bg-card);
            border-radius: var(--radius-l);
            margin-bottom: 24px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-card);
            cursor: pointer;
            position: relative;
        }
        
        .list-item:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            left: 16px; /* ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚‹å ´åˆã¯èª¿æ•´ */
            height: 1px;
            background: var(--separator);
            transform: scaleY(0.5);
        }

        .list-item:active { background: #E5E5EA; }

        .item-label { font-size: 17px; font-weight: 400; }
        .item-value { 
            font-size: 17px; 
            color: var(--text-secondary); 
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        .chevron { opacity: 0.3; font-weight: bold; }

        /* ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ */
        .check-icon { color: var(--accent); font-weight: 600; display: none; }
        .list-item.selected .check-icon { display: block; }
        .list-item.selected .item-label { color: var(--accent); font-weight: 500; }

        /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
        .btn-primary {
            width: 100%;
            background: var(--accent);
            color: white;
            font-size: 17px;
            font-weight: 600;
            padding: 16px;
            border-radius: var(--radius-l);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.97); }
        .btn-primary:disabled { background: #C7C7CC; color: #8E8E93; box-shadow: none; }

        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ãƒãƒ¼ */
        .nav-bar {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background: rgba(242, 242, 247, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .nav-btn {
            border: none;
            background: none;
            color: var(--accent);
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 0;
            cursor: pointer;
        }
        .nav-title {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 17px;
            margin-right: 40px; /* ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ */
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆæ²¡å…¥ãƒ¢ãƒ¼ãƒ‰ï¼‰ */
        #game-screen {
            background: #000;
            padding: 0;
        }

        .camera-layer {
            position: absolute;
            inset: 0;
            opacity: 0.4;
            z-index: 0;
        }
        .camera-layer video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .game-ui {
            position: absolute;
            inset: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: max(20px, var(--safe-top)) max(40px, var(--safe-right)) max(20px, var(--safe-bottom)) max(40px, var(--safe-left));
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        .timer.warning { color: var(--danger); }

        .question-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question-text {
            color: white;
            font-size: clamp(40px, 12vw, 100px);
            font-weight: 800;
            text-align: center;
            line-height: 1.1;
            text-shadow: 0 4px 12px rgba(0,0,0,0.6);
            word-break: keep-all;
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ–ãƒ©ãƒ¼åŠ¹æœï¼‰ */
        .feedback-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .feedback-overlay.correct { background: rgba(52, 199, 89, 0.6); } /* Green */
        .feedback-overlay.pass { background: rgba(255, 149, 0, 0.6); } /* Orange */
        
        .feedback-overlay.show { opacity: 1; }
        
        .fb-emoji { font-size: 100px; margin-bottom: 20px; }
        .fb-text { font-size: 42px; font-weight: 800; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°å…¼ã‚¬ã‚¤ãƒ‰ï¼‰ */
        .status-guide {
            position: absolute;
            bottom: 30px;
            right: 40px;
            text-align: right;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px; height: 10px;
            border-radius: 50%;
            margin-left: 8px;
            background: gray;
        }
        .status-indicator.ready { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-indicator.locked { background: var(--danger); }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
        #count-screen {
            background: rgba(242, 242, 247, 0.95);
            justify-content: center;
            align-items: center;
        }
        .count-num { font-size: 140px; font-weight: 800; color: var(--accent); }

        /* æ¨ªç”»é¢è­¦å‘Š */
        #rotate-alert {
            position: fixed;
            inset: 0;
            background: var(--bg-body);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        @media (orientation: portrait) { #rotate-alert { display: flex; } }

    </style>
</head>
<body>

    <!-- ç¸¦ç”»é¢è­¦å‘Š -->
    <div id="rotate-alert">
        <div style="font-size:60px; margin-bottom:20px;">ğŸ“²</div>
        <h2 style="font-size:20px;">ç”»é¢ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„</h2>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="screen-home" class="screen active">
        <div class="scroll-view">
            <div class="header-large">
                <h1>ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚²ãƒ¼ãƒ </h1>
                <p>ã‚¹ãƒãƒ›ã‚’ãŠã§ã“ã«å½“ã¦ã¦ãƒ—ãƒ¬ã‚¤ï¼</p>
            </div>

            <div class="list-group">
                <div class="list-item" onclick="app.openGenre()">
                    <span class="item-label">ã‚¸ãƒ£ãƒ³ãƒ«</span>
                    <span class="item-value">
                        <span id="home-genre">æœªé¸æŠ</span>
                        <span class="chevron">â€º</span>
                    </span>
                </div>
                <div class="list-item" onclick="app.openTime()">
                    <span class="item-label">åˆ¶é™æ™‚é–“</span>
                    <span class="item-value">
                        <span id="home-time">60ç§’</span>
                        <span class="chevron">â€º</span>
                    </span>
                </div>
            </div>

            <div class="list-group">
                <div class="list-item" onclick="app.toggleRec()">
                    <span class="item-label">ãƒ—ãƒ¬ã‚¤ã‚’éŒ²ç”»</span>
                    <div style="position:relative; width:51px; height:31px; border-radius:16px; background:var(--separator); transition:0.2s;" id="rec-bg">
                        <div style="position:absolute; top:2px; left:2px; width:27px; height:27px; background:white; border-radius:50%; transition:0.2s; box-shadow:0 2px 4px rgba(0,0,0,0.2);" id="rec-knob"></div>
                    </div>
                </div>
            </div>

            <button id="btn-start" class="btn-primary" disabled onclick="app.tryStart()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <p style="text-align:center; color:var(--text-secondary); margin-top:20px; font-size:12px;">v3.5 (Sensor Lock System)</p>
        </div>
    </div>

    <!-- é¸æŠãƒªã‚¹ãƒˆç”»é¢ï¼ˆæ±ç”¨ï¼‰ -->
    <div id="screen-list" class="screen">
        <div class="nav-bar">
            <button class="nav-btn" onclick="app.goHome()">
                <span style="font-size:24px;">â€¹</span> æˆ»ã‚‹
            </button>
            <span class="nav-title" id="list-title">è¨­å®š</span>
        </div>
        <div class="scroll-view" id="list-content">
            <!-- JSã§ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
    <div id="screen-count" class="screen">
        <div class="count-num" id="count-val">3</div>
        <p style="margin-top:20px; font-weight:600; color:var(--text-secondary);">ã‚¹ãƒãƒ›ã‚’å‚ç›´ã«æ§‹ãˆã¦ï¼</p>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="game-screen" class="screen">
        <div class="camera-layer">
            <video id="game-video" autoplay playsinline muted></video>
        </div>
        
        <div class="game-ui">
            <div class="game-header">
                <div class="timer" id="game-timer">60</div>
                <div class="score">æ­£è§£: <span id="game-score">0</span></div>
            </div>

            <div class="question-wrapper">
                <div class="question-text" id="game-question">Ready?</div>
            </div>

            <div class="status-guide">
                <div>ä¸‹ã‚’å‘ã â” æ­£è§£</div>
                <div>ä¸Šã‚’å‘ã â” ãƒ‘ã‚¹</div>
                <div style="margin-top:5px; font-size:12px; opacity:0.8;">
                    SENSOR: <span id="sensor-status">å¾…æ©Ÿä¸­</span>
                    <span class="status-indicator ready" id="sensor-indicator"></span>
                </div>
            </div>
        </div>

        <div id="feedback" class="feedback-overlay">
            <div class="fb-emoji" id="fb-icon">â­•</div>
            <div class="fb-text" id="fb-text">æ­£è§£ï¼</div>
        </div>
    </div>

    <!-- çµæœç”»é¢ -->
    <div id="screen-result" class="screen">
        <div class="scroll-view">
            <div class="header-large">
                <h1>çµæœç™ºè¡¨</h1>
                <p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</p>
            </div>
            
            <div style="padding:20px; background:var(--bg-card); border-radius:var(--radius-l); text-align:center; margin-bottom:24px;">
                <div style="font-size:16px; color:var(--text-secondary);">æ­£è§£æ•°</div>
                <div style="font-size:64px; font-weight:800; color:var(--accent); line-height:1.2;">
                    <span id="res-score">0</span><span style="font-size:24px; color:var(--text-primary);"> å•</span>
                </div>
            </div>

            <button class="btn-primary" onclick="app.goHome()" style="background:var(--bg-card); color:var(--accent);">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>

            <h3 style="margin:30px 0 10px 16px; font-size:14px; color:var(--text-secondary); text-transform:uppercase;">å†…è¨³</h3>
            <div class="list-group">
                <div id="res-list"></div>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šå®šæ•° ---
        const GENRES_URL = 'data/genres.json';
        
        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ ---
        class App {
            constructor() {
                this.state = {
                    genres: [],
                    selectedGenre: null,
                    time: 60,
                    rec: false,
                    
                    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
                    items: [],
                    index: 0,
                    correct: [],
                    pass: [],
                    isPlaying: false,
                    timeLeft: 0,
                    
                    // ã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹ç®¡ç† (ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³)
                    // Status: 'READY' (å‚ç›´ãƒ»å¾…æ©Ÿ) <-> 'LOCKED' (åˆ¤å®šå¾Œãƒ»æˆ»ã‚Šå¾…ã¡)
                    sensorStatus: 'READY',
                    baseGamma: 0, // åŸºæº–è§’åº¦
                };
                
                this.els = {
                    homeGenre: document.getElementById('home-genre'),
                    homeTime: document.getElementById('home-time'),
                    recBg: document.getElementById('rec-bg'),
                    recKnob: document.getElementById('rec-knob'),
                    btnStart: document.getElementById('btn-start'),
                    listTitle: document.getElementById('list-title'),
                    listContent: document.getElementById('list-content'),
                    gameTimer: document.getElementById('game-timer'),
                    gameScore: document.getElementById('game-score'),
                    gameQuestion: document.getElementById('game-question'),
                    gameVideo: document.getElementById('game-video'),
                    feedback: document.getElementById('feedback'),
                    fbIcon: document.getElementById('fb-icon'),
                    fbText: document.getElementById('fb-text'),
                    sensorStatus: document.getElementById('sensor-status'),
                    sensorInd: document.getElementById('sensor-indicator')
                };

                this.init();
            }

            async init() {
                // ã‚¸ãƒ£ãƒ³ãƒ«ãƒ‡ãƒ¼ã‚¿ã®Fetch
                try {
                    const res = await fetch(GENRES_URL);
                    if (!res.ok) throw new Error('Genres not found');
                    const files = await res.json();
                    
                    // å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
                    this.state.genres = await Promise.all(files.map(async file => {
                        const r = await fetch(`data/${file}`);
                        return await r.json();
                    }));
                } catch (e) {
                    console.error(e);
                    alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: dataãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                }
            }

            // --- ç”»é¢é·ç§» ---
            showScreen(id) {
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById(`screen-${id}`).classList.add('active');
            }

            goHome() { this.showScreen('home'); }

            // --- UIæ“ä½œ ---
            openGenre() {
                this.els.listTitle.innerText = 'ã‚¸ãƒ£ãƒ³ãƒ«';
                this.els.listContent.innerHTML = `<div class="list-group">` + 
                    this.state.genres.map(g => `
                        <div class="list-item ${this.state.selectedGenre?.id === g.id ? 'selected' : ''}" 
                             onclick="app.selectGenre('${g.id}')">
                            <span class="item-label">${g.icon} ${g.name}</span>
                            <span class="check-icon">âœ“</span>
                        </div>
                    `).join('') + `</div>`;
                this.showScreen('list');
            }

            selectGenre(id) {
                this.state.selectedGenre = this.state.genres.find(g => g.id === id);
                this.els.homeGenre.innerText = this.state.selectedGenre.name;
                this.els.btnStart.disabled = false;
                this.goHome();
            }

            openTime() {
                this.els.listTitle.innerText = 'åˆ¶é™æ™‚é–“';
                const times = [30, 60, 90, 120, 180];
                this.els.listContent.innerHTML = `<div class="list-group">` + 
                    times.map(t => `
                        <div class="list-item ${this.state.time === t ? 'selected' : ''}" 
                             onclick="app.selectTime(${t})">
                            <span class="item-label">${t}ç§’</span>
                            <span class="check-icon">âœ“</span>
                        </div>
                    `).join('') + `</div>`;
                this.showScreen('list');
            }

            selectTime(t) {
                this.state.time = t;
                this.els.homeTime.innerText = t + 'ç§’';
                this.goHome();
            }

            toggleRec() {
                this.state.rec = !this.state.rec;
                this.els.recBg.style.background = this.state.rec ? 'var(--success)' : 'var(--separator)';
                this.els.recKnob.style.transform = this.state.rec ? 'translateX(20px)' : 'translateX(0)';
            }

            // --- ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ•ãƒ­ãƒ¼ ---
            tryStart() {
                // ã‚»ãƒ³ã‚µãƒ¼æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (iOS 13+)
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(res => {
                            if (res === 'granted') this.startCountdown();
                            else alert('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã§ã™');
                        })
                        .catch(() => this.startCountdown());
                } else {
                    this.startCountdown();
                }
            }

            startCountdown() {
                this.showScreen('count');
                
                // ã‚«ãƒ¡ãƒ©èµ·å‹•
                if (this.state.rec) {
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false })
                        .then(stream => this.els.gameVideo.srcObject = stream)
                        .catch(() => {});
                } else {
                    this.els.gameVideo.srcObject = null;
                }

                let c = 3;
                document.getElementById('count-val').innerText = c;
                this.playSound(600);

                const timer = setInterval(() => {
                    c--;
                    if (c > 0) {
                        document.getElementById('count-val').innerText = c;
                        this.playSound(600);
                    } else {
                        clearInterval(timer);
                        this.startGame();
                    }
                }, 1000);
            }

            startGame() {
                // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
                this.state.items = [...this.state.selectedGenre.items].sort(() => Math.random() - 0.5);
                this.state.index = 0;
                this.state.correct = [];
                this.state.pass = [];
                this.state.timeLeft = this.state.time;
                this.state.isPlaying = true;
                this.state.sensorStatus = 'READY'; // æœ€åˆã¯å…¥åŠ›å—ä»˜
                this.state.baseGamma = null; // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾…ã¡

                this.showScreen('game');
                this.updateGameUI();
                this.playSound(1000, 'square');

                // ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–
                window.addEventListener('deviceorientation', this.handleOrientation.bind(this));

                // ã‚¿ã‚¤ãƒãƒ¼
                this.timerInterval = setInterval(() => {
                    this.state.timeLeft--;
                    this.updateGameUI();
                    if (this.state.timeLeft <= 0) this.finishGame();
                }, 1000);
            }

            updateGameUI() {
                this.els.gameTimer.innerText = this.state.timeLeft;
                this.els.gameScore.innerText = this.state.correct.length;
                this.els.gameQuestion.innerText = this.state.items[this.state.index] || 'çµ‚äº†';
                
                if(this.state.timeLeft <= 5) this.els.gameTimer.classList.add('warning');
            }

            // --- æ ¸å¿ƒï¼šã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«ã‚ˆã‚‹å‚¾ãåˆ¤å®š ---
            handleOrientation(e) {
                if (!this.state.isPlaying) return;

                // æ¨ªæŒã¡æ™‚ã®å‚¾ã = gamma (-90 ~ 90)
                let currentGamma = e.gamma;
                if (currentGamma === null) return;

                // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåˆå›ã®ã¿ã€ç¾åœ¨ã®è§’åº¦ã‚’åŸºæº–0ã¨ã™ã‚‹ï¼‰
                if (this.state.baseGamma === null) {
                    // å‚ç›´ä»˜è¿‘(60~120åº¦ç›¸å½“)ã«ã„ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰åŸºæº–åŒ–
                    // æ¨ªæŒã¡ã®å‚ç›´ã¯GammaãŒç›´è§’ã«è¿‘ã„
                    this.state.baseGamma = currentGamma;
                    return;
                }

                // åŸºæº–ã‹ã‚‰ã®å¤‰åŒ–é‡
                // ä¸‹ã‚’å‘ãï¼ˆæ­£è§£ï¼‰ï¼š Gammaã®çµ¶å¯¾å€¤ãŒæ¸›ã‚‹æ–¹å‘ï¼ˆ0åº¦ï¼æ°´å¹³ã«è¿‘ã¥ãï¼‰
                // ä¸Šã‚’å‘ãï¼ˆãƒ‘ã‚¹ï¼‰ï¼š Gammaã®çµ¶å¯¾å€¤ãŒå¢—ãˆã‚‹æ–¹å‘ï¼ˆç›´è§’ã‚’è¶…ãˆã‚‹ï¼‰
                
                // ç°¡æ˜“åŒ–ï¼šæ¨ªæŒã¡ã§ãŠã§ã“ã«ã¤ã‘ãŸçŠ¶æ…‹ã‚’Baseã¨ã™ã‚‹
                const diff = currentGamma - this.state.baseGamma;

                // ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³
                if (this.state.sensorStatus === 'READY') {
                    this.els.sensorStatus.innerText = "å—ä»˜ä¸­";
                    this.els.sensorInd.className = "status-indicator ready";

                    // é–¾å€¤ï¼ˆ35åº¦å‹•ã‹ã™ï¼‰
                    const THRESHOLD = 35;

                    // 1. æ­£è§£ï¼ˆä¸‹ã‚’å‘ãï¼‰
                    // æ©Ÿç¨®ä¾å­˜ãŒã‚ã‚‹ãŸã‚ã€çµ¶å¯¾å€¤ã®å¤‰åŒ–ã‚’è¦‹ã‚‹ã®ãŒå®‰å…¨
                    // ãŠã§ã“(Vertical)ã‹ã‚‰ä¸‹(Horizontal)ã¸è¡Œãã¨ã€çµ¶å¯¾å€¤ã¯æ¸›ã‚‹
                    if (Math.abs(currentGamma) < Math.abs(this.state.baseGamma) - THRESHOLD) {
                        this.triggerAnswer(true);
                    }
                    // 2. ãƒ‘ã‚¹ï¼ˆä¸Šã‚’å‘ãï¼‰
                    // çµ¶å¯¾å€¤ãŒå¢—ãˆã‚‹ã€ã‚ã‚‹ã„ã¯ç¬¦å·ãŒåè»¢ã™ã‚‹ã»ã©åã‚‹
                    else if (Math.abs(currentGamma) > Math.abs(this.state.baseGamma) + THRESHOLD) {
                        this.triggerAnswer(false);
                    }

                } else if (this.state.sensorStatus === 'LOCKED') {
                    this.els.sensorStatus.innerText = "æˆ»ã—ã¦!";
                    this.els.sensorInd.className = "status-indicator locked";

                    // å¾©å¸°åˆ¤å®šï¼šåŸºæº–è§’åº¦ä»˜è¿‘ï¼ˆÂ±15åº¦ï¼‰ã«æˆ»ã£ãŸã‚‰ãƒ­ãƒƒã‚¯è§£é™¤
                    const RETURN_THRESHOLD = 15;
                    if (Math.abs(currentGamma - this.state.baseGamma) < RETURN_THRESHOLD) {
                        this.state.sensorStatus = 'READY';
                    }
                }
            }

            triggerAnswer(isCorrect) {
                // ã¾ãšãƒ­ãƒƒã‚¯ã—ã¦ã€é€£ç¶šå…¥åŠ›ã‚’é®æ–­
                this.state.sensorStatus = 'LOCKED';
                
                const item = this.state.items[this.state.index];

                if (isCorrect) {
                    this.state.correct.push(item);
                    this.showFeedback('correct', 'â­• æ­£è§£ï¼');
                    this.playSound(1200); // High pitch
                } else {
                    this.state.pass.push(item);
                    this.showFeedback('pass', 'â­ï¸ ãƒ‘ã‚¹');
                    this.playSound(400); // Low pitch
                }

                // æ¬¡ã®å•é¡Œã¸å³åº§ã«æ›´æ–°
                this.state.index++;
                if (this.state.index >= this.state.items.length) this.state.index = 0;
                this.updateGameUI();

                // UIã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å°‘ã—æ®‹ã—ã¦æ¶ˆã™
                setTimeout(() => {
                    this.els.feedback.classList.remove('show');
                }, 600);
            }

            showFeedback(cls, text) {
                this.els.feedback.className = `feedback-overlay show ${cls}`;
                this.els.fbIcon.innerText = cls === 'correct' ? 'â­•' : 'â­ï¸';
                this.els.fbText.innerText = text;
            }

            // --- çµ‚äº†å‡¦ç† ---
            finishGame() {
                this.state.isPlaying = false;
                clearInterval(this.timerInterval);
                window.removeEventListener('deviceorientation', this.handleOrientation);
                
                // ãƒ“ãƒ‡ã‚ªåœæ­¢
                if (this.els.gameVideo.srcObject) {
                    this.els.gameVideo.srcObject.getTracks().forEach(t => t.stop());
                }

                this.playSound(800, 'sawtooth');

                // çµæœè¡¨ç¤ºç”Ÿæˆ
                document.getElementById('res-score').innerText = this.state.correct.length;
                document.getElementById('res-list').innerHTML = 
                    this.state.correct.map(i => 
                        `<div class="list-item"><span class="item-label">${i}</span><span style="color:var(--success)">â­•</span></div>`
                    ).join('') +
                    this.state.pass.map(i => 
                        `<div class="list-item"><span class="item-label">${i}</span><span style="color:var(--warning)">â­ï¸</span></div>`
                    ).join('');
                
                this.showScreen('result');
            }

            // éŸ³å£°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
            playSound(freq, type = 'sine') {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.frequency.value = freq;
                osc.type = type;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                osc.stop(ctx.currentTime + 0.15);
            }
        }

        // ã‚¢ãƒ—ãƒªèµ·å‹•
        const app = new App();

    </script>
</body>
</html>
