<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWAç”¨è¨­å®šï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ãŸæ™‚ã«ã‚¢ãƒ—ãƒªã¨ã—ã¦æŒ¯ã‚‹èˆã†ï¼‰ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚²ãƒ¼ãƒ æ”¹</title>
    <style>
        :root {
            --bg: #121212;
            --text: #ffffff;
            --accent: #0A84FF;
            --success: #30D158;
            --pass: #FF9F0A;
            --danger: #FF453A;
            --card-bg: #1C1C1E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            width: 100vw;
            height: 100dvh; /* å‹•çš„ãªãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã«å¯¾å¿œ */
            overflow: hidden; /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
            position: fixed;
            inset: 0;
        }

        /* å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .screen {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            background: var(--bg);
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            z-index: 10;
        }

        .screen.active { display: flex; }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ãƒ›ãƒ¼ãƒ ç”»é¢ */
        .title-area {
            text-align: center;
            margin-top: 40px;
            margin-bottom: 40px;
        }
        .title-area h1 { font-size: 32px; margin-bottom: 10px; }
        .title-area p { color: #888; font-size: 14px; }

        .menu-card {
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }
        .setting-row:last-child { border-bottom: none; }
        
        .setting-label { display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: bold; }
        .setting-value { color: var(--accent); font-size: 16px; display: flex; align-items: center; gap: 5px; }

        .btn-primary {
            width: 100%;
            max-width: 400px;
            padding: 16px;
            background: var(--accent);
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.96); }
        .btn-primary:disabled { background: #555; color: #888; }

        /* ãƒªã‚¹ãƒˆé¸æŠç”»é¢ */
        .list-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        .list-item {
            background: var(--card-bg);
            padding: 16px;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .list-item:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .list-item:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .list-item.selected { color: var(--accent); }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆå…¨ç”»é¢ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ï¼‰ */
        #game-screen {
            background: #000;
            overflow: hidden;
            touch-action: none;
        }

        .camera-layer {
            position: absolute;
            inset: 0;
            z-index: 0;
            opacity: 0.3;
        }
        .camera-layer video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .game-ui-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            font-size: 24px;
            font-weight: bold;
            padding: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .timer.urgent { color: var(--danger); animation: pulse 0.5s infinite; }

        .question-box {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .question-text {
            font-size: clamp(40px, 12vw, 100px);
            font-weight: 800;
            text-align: center;
            line-height: 1.1;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
            word-break: keep-all;
        }

        .feedback-overlay {
            position: absolute;
            inset: 0;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 900;
            font-size: 80px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .feedback-overlay.correct { background: rgba(48, 209, 88, 0.9); }
        .feedback-overlay.pass { background: rgba(255, 159, 10, 0.9); }
        .feedback-overlay.show { opacity: 1; }

        /* ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º */
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            color: lime;
            font-family: monospace;
            z-index: 100;
            background: rgba(0,0,0,0.5);
            padding: 4px;
            pointer-events: none;
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
        }

        /* ç¸¦ç”»é¢è­¦å‘Š */
        #rotate-warning {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        @media (orientation: portrait) {
            #rotate-warning { display: flex; }
        }
        .rotate-icon { font-size: 50px; margin-bottom: 20px; animation: rotate 2s infinite; }
        @keyframes rotate { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(90deg); } }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
        #countdown-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .count-num { font-size: 150px; font-weight: bold; color: var(--accent); }
        .count-sub { font-size: 20px; margin-top: 20px; color: #888; }

    </style>
</head>
<body>

    <!-- ç¸¦ç”»é¢æ™‚ã®è­¦å‘Š -->
    <div id="rotate-warning">
        <div class="rotate-icon">ğŸ“±</div>
        <h2>ã‚¹ãƒãƒ›ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„</h2>
        <p style="margin-top:10px; color:#888;">ã“ã®ã‚²ãƒ¼ãƒ ã¯æ¨ªç”»é¢å°‚ç”¨ã§ã™</p>
    </div>

    <!-- ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒãƒƒã‚°ç”¨ -->
    <div id="debug-info">Sensor Init...</div>

    <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="screen-home" class="screen active">
        <div class="scrollable-content">
            <div class="title-area">
                <h1>ğŸ­ ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚²ãƒ¼ãƒ </h1>
                <p>ã‚¹ãƒãƒ›ã‚’ãŠã§ã“ã«å½“ã¦ã¦ãƒ—ãƒ¬ã‚¤ï¼</p>
            </div>

            <div class="menu-card">
                <div class="setting-row" id="btn-genre">
                    <span class="setting-label">ğŸ“ ã‚¸ãƒ£ãƒ³ãƒ«</span>
                    <span class="setting-value" id="disp-genre">é¸æŠ ></span>
                </div>
                <div class="setting-row" id="btn-time">
                    <span class="setting-label">â±ï¸ åˆ¶é™æ™‚é–“</span>
                    <span class="setting-value" id="disp-time">60ç§’ ></span>
                </div>
                <div class="setting-row" id="btn-camera" style="border:none;">
                    <span class="setting-label">ğŸ“¹ éŒ²ç”»</span>
                    <label style="position:relative; width:50px; height:30px; background:#333; border-radius:15px; cursor:pointer;">
                        <input type="checkbox" id="chk-camera" style="opacity:0;">
                        <div id="toggle-circle" style="position:absolute; top:2px; left:2px; width:26px; height:26px; background:white; border-radius:50%; transition:0.3s;"></div>
                    </label>
                </div>
            </div>

            <button id="btn-start" class="btn-primary" disabled>ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <p style="margin-top:20px; font-size:12px; color:#555;" id="debug-trigger">ver 2.0 (Sensor Fix)</p>
        </div>
    </div>

    <!-- ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠç”»é¢ -->
    <div id="screen-genre" class="screen">
        <div style="padding: 10px; display:flex; align-items:center;">
            <button class="setting-value" id="back-genre" style="background:none; border:none; font-size:16px;">â† æˆ»ã‚‹</button>
            <span style="flex:1; text-align:center; font-weight:bold;">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ</span>
            <span style="width:60px;"></span>
        </div>
        <div class="scrollable-content">
            <div id="list-genre" class="list-container"></div>
        </div>
    </div>

    <!-- æ™‚é–“é¸æŠç”»é¢ -->
    <div id="screen-time" class="screen">
        <div style="padding: 10px; display:flex; align-items:center;">
            <button class="setting-value" id="back-time" style="background:none; border:none; font-size:16px;">â† æˆ»ã‚‹</button>
            <span style="flex:1; text-align:center; font-weight:bold;">æ™‚é–“é¸æŠ</span>
            <span style="width:60px;"></span>
        </div>
        <div class="scrollable-content">
            <div id="list-time" class="list-container"></div>
        </div>
    </div>

    <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
    <div id="countdown-overlay">
        <div class="count-num" id="count-val">3</div>
        <p class="count-sub">ã‚¹ãƒãƒ›ã‚’ãŠã§ã“ã«å½“ã¦ã¦ãã ã•ã„</p>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="game-screen" class="screen">
        <div class="camera-layer">
            <video id="camera-feed" autoplay playsinline muted></video>
        </div>
        
        <div class="game-ui-layer">
            <div class="game-header">
                <div class="timer" id="game-timer">60</div>
                <div class="score">æ­£è§£: <span id="game-score">0</span></div>
            </div>
            
            <div class="question-box">
                <div class="question-text" id="game-question">æº–å‚™ä¸­...</div>
            </div>

            <div style="text-align:right; font-size:14px; opacity:0.7;">
                <div>ä¸‹ã¸å‚¾ã‘ã¦æ­£è§£ â­•</div>
                <div>ä¸Šã¸å‚¾ã‘ã¦ãƒ‘ã‚¹ â­ï¸</div>
            </div>
        </div>

        <div id="feedback-overlay" class="feedback-overlay">
            <div id="feedback-icon">â­•</div>
            <div id="feedback-text">æ­£è§£ï¼</div>
        </div>
    </div>

    <!-- çµæœç”»é¢ -->
    <div id="screen-result" class="screen">
        <div class="scrollable-content">
            <h2>çµæœç™ºè¡¨</h2>
            <div style="font-size:60px; font-weight:bold; color:var(--accent); margin: 20px 0;">
                <span id="res-score">0</span><span style="font-size:20px; color:#fff;"> å•æ­£è§£</span>
            </div>

            <div style="display:flex; gap:20px; width:100%; max-width:400px; margin-bottom:20px;">
                <button id="btn-home" class="btn-primary" style="background:#333;">ãƒ›ãƒ¼ãƒ ã¸</button>
            </div>

            <div class="list-container" style="width:100%;">
                <h3 style="margin-bottom:10px; font-size:16px; color:#888;">æ­£è§£ã—ãŸãŠé¡Œ</h3>
                <div id="res-list-correct"></div>
                
                <h3 style="margin:20px 0 10px; font-size:16px; color:#888;">ãƒ‘ã‚¹ã—ãŸãŠé¡Œ</h3>
                <div id="res-list-pass"></div>
            </div>
        </div>
    </div>

    <!-- è¨±å¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-perm" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; display:none; justify-content:center; align-items:center;">
        <div style="background:#1C1C1E; padding:30px; border-radius:20px; text-align:center; max-width:300px;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ“±</div>
            <h3 style="margin-bottom:10px;">ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯</h3>
            <p style="font-size:14px; color:#aaa; margin-bottom:20px;">ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã«ã¯å‚¾ãã‚»ãƒ³ã‚µãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</p>
            <button id="btn-perm" class="btn-primary">è¨±å¯ã™ã‚‹</button>
        </div>
    </div>

    <script>
        // --- è¨­å®šãƒ‡ãƒ¼ã‚¿ ---
        const GENRES_URL = 'data/genres.json';
        
        // --- ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ ---
        const state = {
            genres: [],
            selectedGenre: null,
            time: 60,
            useCamera: false,
            
            // ã‚²ãƒ¼ãƒ å†…çŠ¶æ…‹
            questions: [],
            qIndex: 0,
            correctItems: [],
            passItems: [],
            timer: null,
            timeLeft: 0,
            isPlaying: false,
            isCooldown: false,
            
            // ã‚»ãƒ³ã‚µãƒ¼é–¢é€£
            baseAngle: null, // åŸºæº–è§’åº¦ï¼ˆãŠã§ã“ã«å½“ã¦ãŸæ™‚ã®è§’åº¦ï¼‰
            lastAngle: 0,
            threshold: 25,   // åˆ¤å®šé–¾å€¤ï¼ˆåº¦ï¼‰
            orientationPermitted: false
        };

        // --- DOMè¦ç´  ---
        const els = {
            screens: {
                home: document.getElementById('screen-home'),
                genre: document.getElementById('screen-genre'),
                time: document.getElementById('screen-time'),
                game: document.getElementById('game-screen'),
                result: document.getElementById('screen-result')
            },
            home: {
                genre: document.getElementById('disp-genre'),
                time: document.getElementById('disp-time'),
                cameraChk: document.getElementById('chk-camera'),
                toggle: document.getElementById('toggle-circle'),
                startBtn: document.getElementById('btn-start')
            },
            lists: {
                genre: document.getElementById('list-genre'),
                time: document.getElementById('list-time'),
                resCorrect: document.getElementById('res-list-correct'),
                resPass: document.getElementById('res-list-pass')
            },
            game: {
                timer: document.getElementById('game-timer'),
                score: document.getElementById('game-score'),
                question: document.getElementById('game-question'),
                video: document.getElementById('camera-feed'),
                feedback: document.getElementById('feedback-overlay'),
                fbIcon: document.getElementById('feedback-icon'),
                fbText: document.getElementById('feedback-text')
            },
            countdown: document.getElementById('countdown-overlay'),
            countVal: document.getElementById('count-val'),
            debug: document.getElementById('debug-info'),
            permModal: document.getElementById('modal-perm')
        };

        // --- éŸ³å£°ç®¡ç† ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        const sounds = {
            ok: () => { playTone(880, 'sine', 0.1); setTimeout(()=>playTone(1760, 'sine', 0.2), 100); },
            pass: () => { playTone(300, 'triangle', 0.3); },
            count: () => { playTone(600, 'sine', 0.1); },
            start: () => { playTone(1200, 'square', 0.5); },
            end: () => { playTone(200, 'sawtooth', 0.8); }
        };

        // --- åˆæœŸåŒ– ---
        async function init() {
            try {
                // ã‚¸ãƒ£ãƒ³ãƒ«èª­ã¿è¾¼ã¿
                const res = await fetch(GENRES_URL);
                const files = await res.json();
                state.genres = await Promise.all(files.map(async f => {
                    const r = await fetch(`data/${f}`);
                    return await r.json();
                }));
                
                renderGenreList();
                renderTimeList();
                
            } catch(e) {
                alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e);
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            document.getElementById('btn-genre').onclick = () => changeScreen('genre');
            document.getElementById('btn-time').onclick = () => changeScreen('time');
            document.getElementById('back-genre').onclick = () => changeScreen('home');
            document.getElementById('back-time').onclick = () => changeScreen('home');
            
            document.getElementById('btn-camera').onclick = (e) => {
                if(e.target.tagName === 'INPUT') return; // ãƒãƒ–ãƒªãƒ³ã‚°é˜²æ­¢
                els.home.cameraChk.checked = !els.home.cameraChk.checked;
                updateCameraToggle();
            };
            els.home.cameraChk.onchange = updateCameraToggle;
            
            els.home.startBtn.onclick = tryStartGame;
            document.getElementById('btn-home').onclick = () => changeScreen('home');
            
            // è¨±å¯ãƒœã‚¿ãƒ³
            document.getElementById('btn-perm').onclick = async () => {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        state.orientationPermitted = true;
                        els.permModal.style.display = 'none';
                        startGameSequence();
                    } else {
                        alert('ã‚»ãƒ³ã‚µãƒ¼ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                } catch(e) {
                    console.error(e);
                    // Androidç­‰ã¯ã“ã“ã«æ¥ã‚‹
                    state.orientationPermitted = true;
                    els.permModal.style.display = 'none';
                    startGameSequence();
                }
            };
            
            // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºãƒˆã‚°ãƒ«
            let debugClicks = 0;
            document.getElementById('debug-trigger').onclick = () => {
                debugClicks++;
                if(debugClicks > 5) els.debug.style.display = 'block';
            };
        }

        function updateCameraToggle() {
            state.useCamera = els.home.cameraChk.checked;
            els.home.toggle.style.transform = state.useCamera ? 'translateX(20px)' : 'translateX(0)';
            els.home.toggle.style.background = state.useCamera ? 'var(--success)' : 'white';
        }

        function changeScreen(id) {
            Object.values(els.screens).forEach(s => s.classList.remove('active'));
            els.screens[id].classList.add('active');
        }

        function renderGenreList() {
            els.lists.genre.innerHTML = state.genres.map(g => `
                <div class="list-item ${state.selectedGenre?.id === g.id ? 'selected' : ''}" 
                     onclick="selectGenre('${g.id}')">
                    <span>${g.icon} ${g.name}</span>
                    <span>${state.selectedGenre?.id === g.id ? 'âœ”' : ''}</span>
                </div>
            `).join('');
        }

        window.selectGenre = (id) => {
            state.selectedGenre = state.genres.find(g => g.id === id);
            els.home.genre.innerText = state.selectedGenre.name;
            els.home.startBtn.disabled = false;
            renderGenreList();
            changeScreen('home');
        };

        function renderTimeList() {
            const times = [30, 60, 90, 120, 180];
            els.lists.time.innerHTML = times.map(t => `
                <div class="list-item ${state.time === t ? 'selected' : ''}" 
                     onclick="selectTime(${t})">
                    <span>${t}ç§’ (${t/60}åˆ†)</span>
                    <span>${state.time === t ? 'âœ”' : ''}</span>
                </div>
            `).join('');
        }

        window.selectTime = (t) => {
            state.time = t;
            els.home.time.innerText = t + 'ç§’';
            renderTimeList();
            changeScreen('home');
        };

        // --- ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç† ---
        function tryStartGame() {
            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ï¼‰
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log('Fullscreen failed', e));
            }

            // iOS 13+ ã®ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ç¢ºèª
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function' && 
                !state.orientationPermitted) {
                els.permModal.style.display = 'flex';
            } else {
                startGameSequence();
            }
        }

        async function startGameSequence() {
            // ã‚«ãƒ¡ãƒ©æº–å‚™
            if (state.useCamera) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                    els.game.video.srcObject = stream;
                } catch(e) {
                    console.error("Camera fail", e);
                }
            } else {
                els.game.video.srcObject = null;
            }

            // å•é¡Œã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            state.questions = [...state.selectedGenre.items].sort(() => Math.random() - 0.5);
            state.qIndex = 0;
            state.correctItems = [];
            state.passItems = [];
            
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
            els.countdown.style.display = 'flex';
            let count = 3;
            els.countVal.innerText = count;
            sounds.count();
            
            const countInt = setInterval(() => {
                count--;
                if(count > 0) {
                    els.countVal.innerText = count;
                    sounds.count();
                } else {
                    clearInterval(countInt);
                    els.countdown.style.display = 'none';
                    startMainGame();
                }
            }, 1000);
        }

        // --- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— ---
        function startMainGame() {
            changeScreen('game');
            state.isPlaying = true;
            state.timeLeft = state.time;
            state.baseAngle = null; // åŸºæº–ãƒªã‚»ãƒƒãƒˆ
            
            sounds.start();
            updateQuestion();
            updateTimerUI();
            
            // ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–é–‹å§‹
            window.addEventListener('deviceorientation', handleOrientation);

            // ã‚¿ã‚¤ãƒãƒ¼
            state.timer = setInterval(() => {
                state.timeLeft--;
                updateTimerUI();
                if(state.timeLeft <= 5) els.game.timer.classList.add('urgent');
                else els.game.timer.classList.remove('urgent');

                if(state.timeLeft <= 0) endGame();
            }, 1000);
        }

        function updateQuestion() {
            if(state.qIndex >= state.questions.length) state.qIndex = 0; // ãƒ«ãƒ¼ãƒ—
            els.game.question.innerText = state.questions[state.qIndex];
            // æ–°ã—ã„å•é¡ŒãŒå‡ºãŸã‚‰ã€ãã®ç¬é–“ã®è§’åº¦ã‚’åŸºæº–ã«ã™ã‚‹ã®ã§ã¯ãªãã€
            // ã€Œåˆ¤å®šæ¸ˆã¿ã€ãƒ•ãƒ©ã‚°ã‚’ä¸‹ã‚ã™ã ã‘ã§ã€åŸºæº–è§’åº¦ã¯ã€ŒãŠã§ã“ã«å½“ã¦ã¦å®‰å®šã—ãŸä½ç½®ã€ã‚’ç¶­æŒã™ã¹ãã ãŒã€
            // ç°¡æ˜“åŒ–ã®ãŸã‚ã€Œæ­£è§£å¾Œã€æˆ»ã£ã¦ããŸã‚‰ãƒªã‚»ãƒƒãƒˆã€ã™ã‚‹æ–¹å¼ã‚’ã¨ã‚‹
        }

        function updateTimerUI() {
            els.game.timer.innerText = state.timeLeft;
            els.game.score.innerText = state.correctItems.length;
        }

        // --- æ ¸å¿ƒï¼šå‚¾ãåˆ¤å®š ---
        function handleOrientation(e) {
            if(!state.isPlaying || state.isCooldown) return;

            // æ¨ªå‘ãã®å ´åˆã€ãŠè¾å„€æ–¹å‘ï¼ˆé•·è¾ºã®å›è»¢ï¼‰ã¯ gamma ã«å‡ºã‚‹ã€‚
            // ã—ã‹ã—ã€iOSã¨Androidã§ç¬¦å·ãŒé€†ã ã£ãŸã‚Šã€90åº¦ã‚’è¶…ãˆã‚‹ã¨åè»¢ã—ãŸã‚Šã™ã‚‹ã€‚
            
            // æœ€ã‚‚å …ç‰¢ãªæ–¹æ³•ï¼š
            // ã‚¹ãƒãƒ›ãŒå‚ç›´ï¼ˆãŠã§ã“ï¼‰ã«ã‚ã‚‹ã¨ãã€Gamma ã¯ãŠã‚ˆã +/- 90åº¦ï¼ˆã¾ãŸã¯0åº¦ä»˜è¿‘ã€æŒã¡æ–¹ã«ã‚ˆã‚‹ï¼‰ã€‚
            // Beta ã¯ãŠã‚ˆã 0åº¦ã€‚
            
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œç¾åœ¨ã®Gammaå€¤ã€ã‚’ç›£è¦–ã—ã€
            // ã‚²ãƒ¼ãƒ é–‹å§‹ç›´å¾Œ(ã¾ãŸã¯åˆ¤å®šå¾©å¸°å¾Œ)ã®å€¤ã‚’ã€ŒåŸºæº–(Zero)ã€ã¨ã™ã‚‹ã€‚
            
            let angle = e.gamma; 
            // â€»ã‚‚ã—ç«¯æœ«ãŒç¸¦æŒã¡ãªã‚‰ beta ã‚’ä½¿ã†ã¹ãã ãŒã€æ¨ªæŒã¡å‰æã¨ã™ã‚‹ã€‚
            // Debug
            els.debug.innerText = `B:${Math.round(e.beta)} G:${Math.round(e.gamma)} Base:${Math.round(state.baseAngle)}`;

            if (angle === null) return;

            // åŸºæº–ãŒãªã‘ã‚Œã°è¨­å®šï¼ˆã“ã‚ŒãŒã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            if (state.baseAngle === null) {
                // å®‰å®šã™ã‚‹ã¾ã§å¾…ã¤ã®ã‚‚æ‰‹ã ãŒã€å³æ™‚è¨­å®š
                state.baseAngle = angle;
                return;
            }

            const diff = angle - state.baseAngle;

            // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
            // ä¸€èˆ¬çš„ã«ã€æ¨ªæŒã¡ã§ãŠã§ã“ã‹ã‚‰ã€Œä¸‹ï¼ˆåºŠï¼‰ã€ã¸ç”»é¢ã‚’å‘ã‘ã‚‹ã¨ã€Gammaå€¤ã¯å¤‰åŒ–ã™ã‚‹ã€‚
            // å¤‰åŒ–é‡ãŒé–¾å€¤ã‚’è¶…ãˆãŸã‚‰åˆ¤å®šã€‚
            
            if (Math.abs(diff) > state.threshold) {
                // ã©ã£ã¡ãŒæ­£è§£ã§ã©ã£ã¡ãŒãƒ‘ã‚¹ã‹ï¼Ÿ
                // å®Ÿéš›ã«å‹•ã‹ã™ã¨ã€æ©Ÿç¨®ã«ã‚ˆã‚‹ãŒ
                // ç”»é¢ã‚’ä¼ã›ã‚‹ï¼ˆæ­£è§£ï¼‰â†’ å€¤ãŒå¤§ããå¤‰åŒ–
                // ç”»é¢ã‚’ç©ºã¸ï¼ˆãƒ‘ã‚¹ï¼‰â†’ é€†ã¸å¤‰åŒ–
                
                // å¤šãã®ãƒ‡ãƒã‚¤ã‚¹ã§ã€
                // åˆæœŸ(90åº¦ä»˜è¿‘) -> ç”»é¢ä¸‹å‘ã‘ã‚‹ -> 0åº¦ã¸å‘ã‹ã† (å·®åˆ†ãƒã‚¤ãƒŠã‚¹ or ãƒ—ãƒ©ã‚¹)
                // ã“ã‚Œã¯å®Ÿæ©Ÿã§ç¬¦å·ãŒã¾ã¡ã¾ã¡ãªã®ã§ã€
                // ã€Œå¤§ããå‹•ã„ãŸã€ã“ã¨ã ã‘æ¤œçŸ¥ã—ã€ä¸€æ—¦ã€Œæ­£è§£ã€ã¨ã™ã‚‹ç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰ã‹ã€
                // ã¾ãŸã¯ã€Œä¸Šã€ã€Œä¸‹ã€ã‚’å³å¯†ã«åˆ†ã‘ã‚‹ã‹ã€‚
                
                // ä»Šå›ã¯ã€Œä¸‹ï¼ˆæ­£è§£ï¼‰ã€ã€Œä¸Šï¼ˆãƒ‘ã‚¹ï¼‰ã€ã‚’åˆ†ã‘ãŸã„ã€‚
                // ç”»é¢ã‚’æ‰‹å‰ã«å€’ã™ï¼ˆä¸‹ã‚’è¦‹ã‚‹ï¼‰ã¨ Gamma ã¯ 0 ã«è¿‘ã¥ãï¼ˆçµ¶å¯¾å€¤ãŒæ¸›ã‚‹ï¼‰ã€‚
                // ç”»é¢ã‚’å¾Œã‚ã«é€¸ã‚‰ã™ï¼ˆä¸Šã‚’è¦‹ã‚‹ï¼‰ã¨ Gamma ã¯ 90 ã‚’è¶…ãˆã‚‹ã€ã¾ãŸã¯é€†å´ã¸ã€‚
                
                // ç°¡æ˜“åˆ¤å®šï¼š
                // diff > threshold  => A
                // diff < -threshold => B
                
                // iPhone(æ¨ªå·¦): ç›´ç«‹=-90, ä¸‹ã¸å‚¾ã‘ã‚‹= -45 (diff +45) -> æ­£è§£
                // Android(æ¨ªå·¦): ç›´ç«‹=90, ä¸‹ã¸å‚¾ã‘ã‚‹= 45 (diff -45) -> æ­£è§£
                // â€»ã“ã®ç¬¦å·å•é¡ŒãŒå„ä»‹ã€‚
                
                // â˜…è§£æ±ºç­–:
                // ã€Œçµ¶å¯¾å€¤ãŒæ¸›ã‚‹æ–¹å‘ï¼ˆ0ã«è¿‘ã¥ãï¼‰ã€ï¼ã€Œç”»é¢ãŒæ°´å¹³ï¼ˆåºŠï¼‰ã«è¿‘ã¥ãã€ï¼ã€Œæ­£è§£ï¼ˆä¸‹ï¼‰ã€
                // ã€Œçµ¶å¯¾å€¤ãŒå¢—ãˆã‚‹æ–¹å‘ï¼ˆå‚ç›´ã‚’è¶…ãˆã‚‹ï¼‰ã€ï¼ã€Œãƒ‘ã‚¹ï¼ˆä¸Šï¼‰ã€
                
                const absCurrent = Math.abs(angle);
                const absBase = Math.abs(state.baseAngle);
                
                if (absCurrent < absBase - state.threshold) {
                    // åºŠã«è¿‘ã¥ã„ãŸ -> æ­£è§£
                    triggerAnswer(true);
                } else if (absCurrent > absBase + state.threshold) {
                    // å¤©äº•ã«å‘ã„ãŸ -> ãƒ‘ã‚¹
                    triggerAnswer(false);
                }
            }
        }

        function triggerAnswer(isCorrect) {
            state.isCooldown = true;
            const item = state.questions[state.qIndex];

            if (isCorrect) {
                state.correctItems.push(item);
                sounds.ok();
                showFeedback('correct', 'â­• æ­£è§£ï¼');
            } else {
                state.passItems.push(item);
                sounds.pass();
                showFeedback('pass', 'â­ï¸ ãƒ‘ã‚¹');
            }

            // æ¬¡ã®å•é¡Œã¸
            setTimeout(() => {
                state.qIndex++;
                updateQuestion();
                hideFeedback();
                
                // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è§£é™¤ï¼†åŸºæº–è§’åº¦ãƒªã‚»ãƒƒãƒˆï¼ˆé‡è¦ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé ­ã‚’æˆ»ã—ãŸä½ç½®ã‚’æ–°åŸºæº–ã«ã™ã‚‹ï¼‰
                // ãŸã ã—å³åº§ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã¨ã€æˆ»ã‚‹å‹•ä½œã§é€†åˆ¤å®šã•ã‚Œã‚‹ã®ã§ã€
                // ã€Œå®‰å®šå¾…ã¡ã€ã‚’å…¥ã‚Œã‚‹ã®ãŒç†æƒ³ã ãŒã€ç°¡æ˜“çš„ã«
                // ã€Œ1ç§’é–“ã¯åˆ¤å®šã—ãªã„ã€ã‹ã¤ã€Œãã®å¾Œã®æœ€åˆã®å€¤ã‚’æ–°åŸºæº–ã«ã™ã‚‹ã€
                setTimeout(() => {
                    state.baseAngle = null; // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å†è¨­å®šã•ã‚Œã‚‹
                    state.isCooldown = false;
                }, 500); 
            }, 800);
        }

        function showFeedback(cls, text) {
            els.game.feedback.className = `feedback-overlay show ${cls}`;
            els.game.fbIcon.innerText = cls === 'correct' ? 'â­•' : 'â­ï¸';
            els.game.fbText.innerText = text;
        }

        function hideFeedback() {
            els.game.feedback.classList.remove('show');
        }

        function endGame() {
            state.isPlaying = false;
            clearInterval(state.timer);
            window.removeEventListener('deviceorientation', handleOrientation);
            
            // ã‚«ãƒ¡ãƒ©åœæ­¢
            if(els.game.video.srcObject) {
                els.game.video.srcObject.getTracks().forEach(t => t.stop());
            }

            sounds.end();
            showResult();
        }

        function showResult() {
            changeScreen('result');
            document.getElementById('res-score').innerText = state.correctItems.length;
            
            els.lists.resCorrect.innerHTML = state.correctItems.map(t => 
                `<div class="list-item"><span>${t}</span><span style="color:var(--success)">â­•</span></div>`
            ).join('') || '<div style="padding:10px; color:#666;">ãªã—</div>';
            
            els.lists.resPass.innerHTML = state.passItems.map(t => 
                `<div class="list-item"><span>${t}</span><span style="color:var(--pass)">â­ï¸</span></div>`
            ).join('') || '<div style="padding:10px; color:#666;">ãªã—</div>';
        }

        // é–‹å§‹
        init();

    </script>
</body>
</html>
